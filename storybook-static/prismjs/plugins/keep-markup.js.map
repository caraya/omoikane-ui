{"version":3,"file":"keep-markup.js","sources":["../../src/plugins/keep-markup/keep-markup.js"],"sourcesContent":["import prism from '../../global.js';\nimport { isActive } from '../../shared/dom-util.js';\n\n/**\n *\n * @param {ChildNode} child\n * @returns {child is Element}\n */\nfunction isElement (child) {\n\treturn child.nodeType === 1;\n}\n\n/**\n *\n * @param {ChildNode} child\n * @returns {child is Text}\n */\nfunction isText (child) {\n\treturn child.nodeType === 3;\n}\n\n/** @type {import('../../types.d.ts').PluginProto<'keep-markup'>} */\nconst Self = {\n\tid: 'keep-markup',\n\toptional: 'normalize-whitespace',\n\teffect (Prism) {\n\t\treturn Prism.hooks.add({\n\t\t\t'before-highlight': env => {\n\t\t\t\tif (!env.element.children.length) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (!isActive(env.element, 'keep-markup', true)) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst dropTokens = isActive(env.element, 'drop-tokens', false);\n\t\t\t\t/**\n\t\t\t\t * Returns whether the given element should be kept.\n\t\t\t\t *\n\t\t\t\t * @param {Element} element\n\t\t\t\t * @returns {boolean}\n\t\t\t\t */\n\t\t\t\tfunction shouldKeep (element) {\n\t\t\t\t\tif (\n\t\t\t\t\t\tdropTokens &&\n\t\t\t\t\t\telement.nodeName.toLowerCase() === 'span' &&\n\t\t\t\t\t\telement.classList.contains('token')\n\t\t\t\t\t) {\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\tlet pos = 0;\n\t\t\t\t/** @type {NodeData[]} */\n\t\t\t\tconst data = [];\n\n\t\t\t\t/**\n\t\t\t\t * @param {Element} element\n\t\t\t\t */\n\t\t\t\tfunction processElement (element) {\n\t\t\t\t\tif (!shouldKeep(element)) {\n\t\t\t\t\t\t// don't keep this element and just process its children\n\t\t\t\t\t\tprocessChildren(element);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t/** @type {NodeData} */\n\t\t\t\t\tconst o = {\n\t\t\t\t\t\t// Store original element so we can restore it after highlighting\n\t\t\t\t\t\telement,\n\t\t\t\t\t\tposOpen: pos,\n\t\t\t\t\t\tposClose: NaN,\n\t\t\t\t\t};\n\t\t\t\t\tdata.push(o);\n\n\t\t\t\t\tprocessChildren(element);\n\n\t\t\t\t\to.posClose = pos;\n\t\t\t\t}\n\n\t\t\t\t/**\n\t\t\t\t * @param {Element} element\n\t\t\t\t */\n\t\t\t\tfunction processChildren (element) {\n\t\t\t\t\tfor (let i = 0, l = element.childNodes.length; i < l; i++) {\n\t\t\t\t\t\tconst child = element.childNodes[i];\n\t\t\t\t\t\tif (isElement(child)) {\n\t\t\t\t\t\t\tprocessElement(child);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (isText(child)) {\n\t\t\t\t\t\t\tpos += child.data.length;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tprocessChildren(env.element);\n\n\t\t\t\tif (data.length) {\n\t\t\t\t\t// data is an array of all existing tags\n\t\t\t\t\tenv.markupData = data;\n\t\t\t\t}\n\t\t\t},\n\t\t\t'after-highlight': env => {\n\t\t\t\t/** @type {NodeData[]} */\n\t\t\t\tconst data = env.markupData ?? [];\n\t\t\t\tif (data.length) {\n\t\t\t\t\t/**\n\t\t\t\t\t * @param {Element} elt\n\t\t\t\t\t * @param {NodeState} nodeState\n\t\t\t\t\t */\n\t\t\t\t\tconst walk = (elt, nodeState) => {\n\t\t\t\t\t\tfor (let i = 0, l = elt.childNodes.length; i < l; i++) {\n\t\t\t\t\t\t\tconst child = elt.childNodes[i];\n\n\t\t\t\t\t\t\tif (isElement(child)) {\n\t\t\t\t\t\t\t\tif (!walk(child, nodeState)) {\n\t\t\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse if (isText(child)) {\n\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\t!nodeState.start &&\n\t\t\t\t\t\t\t\t\tnodeState.pos + child.data.length > nodeState.node.posOpen\n\t\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\t\t// We found the start position\n\t\t\t\t\t\t\t\t\tnodeState.start = [\n\t\t\t\t\t\t\t\t\t\tchild,\n\t\t\t\t\t\t\t\t\t\tnodeState.node.posOpen - nodeState.pos,\n\t\t\t\t\t\t\t\t\t];\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\tnodeState.start &&\n\t\t\t\t\t\t\t\t\tnodeState.pos + child.data.length >= nodeState.node.posClose\n\t\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\t\t// We found the end position\n\t\t\t\t\t\t\t\t\tnodeState.end = [\n\t\t\t\t\t\t\t\t\t\tchild,\n\t\t\t\t\t\t\t\t\t\tnodeState.node.posClose - nodeState.pos,\n\t\t\t\t\t\t\t\t\t];\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tnodeState.pos += child.data.length;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (nodeState.start && nodeState.end) {\n\t\t\t\t\t\t\t\t// Select the range and wrap it with the element\n\t\t\t\t\t\t\t\tconst range = document.createRange();\n\t\t\t\t\t\t\t\trange.setStart(...nodeState.start);\n\t\t\t\t\t\t\t\trange.setEnd(...nodeState.end);\n\t\t\t\t\t\t\t\tnodeState.node.element.innerHTML = '';\n\t\t\t\t\t\t\t\tnodeState.node.element.appendChild(range.extractContents());\n\t\t\t\t\t\t\t\trange.insertNode(nodeState.node.element);\n\t\t\t\t\t\t\t\trange.detach();\n\n\t\t\t\t\t\t\t\t// Process is over\n\t\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t};\n\n\t\t\t\t\t// For each tag, we walk the DOM to reinsert it\n\t\t\t\t\tdata.forEach(node => {\n\t\t\t\t\t\twalk(env.element, { node, pos: 0 });\n\t\t\t\t\t});\n\t\t\t\t\t// Store new highlightedCode for later hooks calls\n\t\t\t\t\tenv.highlightedCode = env.element.innerHTML;\n\t\t\t\t}\n\t\t\t},\n\t\t});\n\t},\n};\n\nexport default Self;\n\nprism.pluginRegistry.add(Self);\n\n/**\n * @typedef {object} NodeData\n * @property {Element} element\n * @property {number} posOpen\n * @property {number} posClose\n */\n\n/**\n * @typedef {[node: Text, pos: number]} End\n */\n\n/**\n * @typedef {object} NodeState\n * @property {NodeData} node\n * @property {number} pos\n * @property {End} [start]\n * @property {End} [end]\n */\n"],"names":["isElement","child","nodeType","isText","Self","id","optional","effect","Prism","hooks","add","env","element","children","length","isActive","dropTokens","pos","data","processElement","nodeName","toLowerCase","classList","contains","shouldKeep","processChildren","o","posOpen","posClose","NaN","push","i","l","childNodes","markupData","walk","elt","nodeState","start","node","end","range","document","createRange","setStart","setEnd","innerHTML","appendChild","extractContents","insertNode","detach","forEach","highlightedCode","prism","pluginRegistry"],"mappings":"wKAQA,SAASA,EAAWC,GACnB,OAA0B,IAAnBA,EAAMC,QACd,CAOA,SAASC,EAAQF,GAChB,OAA0B,IAAnBA,EAAMC,QACd,CAGK,MAACE,EAAO,CACZC,GAAI,cACJC,SAAU,uBACVC,OAAQC,GACAA,EAAMC,MAAMC,IAAI,CACtB,mBAAoBC,IACnB,IAAKA,EAAIC,QAAQC,SAASC,OACzB,OAGD,IAAKC,EAASJ,EAAIC,QAAS,eAAe,GACzC,OAGD,MAAMI,EAAaD,EAASJ,EAAIC,QAAS,eAAe,GAkBxD,IAAIK,EAAM,EAEV,MAAMC,EAAO,GAKb,SAASC,EAAgBP,GACxB,IAnBD,CAAqBA,IAEnBI,GACmC,SAAnCJ,EAAQQ,SAASC,gBACjBT,EAAQU,UAAUC,SAAS,SAevBC,CAAWZ,GAGf,YADAa,EAAgBb,GAKjB,MAAMc,EAAI,CAETd,UACAe,QAASV,EACTW,SAAUC,KAEXX,EAAKY,KAAKJ,GAEVD,EAAgBb,GAEhBc,EAAEE,SAAWX,CAClB,CAKI,SAASQ,EAAiBb,GACzB,IAAK,IAAImB,EAAI,EAAGC,EAAIpB,EAAQqB,WAAWnB,OAAQiB,EAAIC,EAAGD,IAAK,CAC1D,MAAM9B,EAAQW,EAAQqB,WAAWF,GAC7B/B,EAAUC,GACbkB,EAAelB,GAEPE,EAAOF,KACfgB,GAAOhB,EAAMiB,KAAKJ,OAEzB,CACA,CACIW,EAAgBd,EAAIC,SAEhBM,EAAKJ,SAERH,EAAIuB,WAAahB,EACtB,EAEG,kBAAmBP,IAElB,MAAMO,EAAOP,EAAIuB,YAAc,GAC/B,GAAIhB,EAAKJ,OAAQ,CAKhB,MAAMqB,EAAO,CAACC,EAAKC,KAClB,IAAK,IAAIN,EAAI,EAAGC,EAAII,EAAIH,WAAWnB,OAAQiB,EAAIC,EAAGD,IAAK,CACtD,MAAM9B,EAAQmC,EAAIH,WAAWF,GAE7B,GAAI/B,EAAUC,IACb,IAAKkC,EAAKlC,EAAOoC,GAChB,OAAO,OAGAlC,EAAOF,MAEboC,EAAUC,OACXD,EAAUpB,IAAMhB,EAAMiB,KAAKJ,OAASuB,EAAUE,KAAKZ,UAGnDU,EAAUC,MAAQ,CACjBrC,EACAoC,EAAUE,KAAKZ,QAAUU,EAAUpB,MAIpCoB,EAAUC,OACVD,EAAUpB,IAAMhB,EAAMiB,KAAKJ,QAAUuB,EAAUE,KAAKX,WAGpDS,EAAUG,IAAM,CACfvC,EACAoC,EAAUE,KAAKX,SAAWS,EAAUpB,MAItCoB,EAAUpB,KAAOhB,EAAMiB,KAAKJ,QAG7B,GAAIuB,EAAUC,OAASD,EAAUG,IAAK,CAErC,MAAMC,EAAQC,SAASC,cASvB,OARAF,EAAMG,YAAYP,EAAUC,OAC5BG,EAAMI,UAAUR,EAAUG,KAC1BH,EAAUE,KAAK3B,QAAQkC,UAAY,GACnCT,EAAUE,KAAK3B,QAAQmC,YAAYN,EAAMO,mBACzCP,EAAMQ,WAAWZ,EAAUE,KAAK3B,SAChC6B,EAAMS,UAGC,CACf,CACA,CACM,OAAO,CAAI,EAIZhC,EAAKiC,SAAQZ,IACZJ,EAAKxB,EAAIC,QAAS,CAAE2B,OAAMtB,IAAK,GAAI,IAGpCN,EAAIyC,gBAAkBzC,EAAIC,QAAQkC,SACvC,MAQAO,EAAMC,eAAe5C,IAAIN"}