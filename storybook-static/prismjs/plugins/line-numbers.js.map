{"version":3,"file":"line-numbers.js","sources":["../../src/plugins/line-numbers/line-numbers.js"],"sourcesContent":["import prism from '../../global.js';\nimport { getParentPre, isActive } from '../../shared/dom-util.js';\nimport { isNonNull, noop } from '../../shared/util.js';\nimport { combineCallbacks } from '../../util/combine-callbacks.js';\n\n/**\n * Plugin name which is used as a class name for <pre> which is activating the plugin\n */\nconst PLUGIN_NAME = 'line-numbers';\n\n/**\n * Regular expression used for determining line breaks\n */\nconst NEW_LINE_EXP = /\\n(?!$)/g;\n\n/**\n * Queries for the `line-numbers-rows` element.\n *\n * @param {Element} element\n * @returns {HTMLElement | null}\n */\nfunction getLineNumbersRows (element) {\n\treturn element.querySelector('.line-numbers-rows');\n}\n\n/**\n * Resizes the given elements.\n *\n * @param {Element[]} elements\n */\nfunction resizeElements (elements) {\n\telements = elements.filter(e => {\n\t\tconst codeStyles = getComputedStyle(e);\n\t\tconst whiteSpace = codeStyles.whiteSpace;\n\t\treturn whiteSpace === 'pre-wrap' || whiteSpace === 'pre-line';\n\t});\n\n\tif (elements.length === 0) {\n\t\treturn;\n\t}\n\n\tconst infos = /** @type {Info[]} */ (\n\t\telements\n\t\t\t.map(element => {\n\t\t\t\tconst codeElement = element.querySelector('code');\n\t\t\t\tconst lineNumbersWrapper = getLineNumbersRows(element);\n\t\t\t\tif (!codeElement || !lineNumbersWrapper) {\n\t\t\t\t\treturn undefined;\n\t\t\t\t}\n\n\t\t\t\t/** @type {HTMLElement | null} */\n\t\t\t\tlet lineNumberSizer = element.querySelector('.line-numbers-sizer');\n\t\t\t\t// @ts-expect-error - codeElement.textContent is not null\n\t\t\t\tconst codeLines = codeElement.textContent.split(NEW_LINE_EXP);\n\n\t\t\t\tif (!lineNumberSizer) {\n\t\t\t\t\tlineNumberSizer = document.createElement('span');\n\t\t\t\t\tlineNumberSizer.className = 'line-numbers-sizer';\n\n\t\t\t\t\tcodeElement.appendChild(lineNumberSizer);\n\t\t\t\t}\n\n\t\t\t\tlineNumberSizer.innerHTML = '0';\n\t\t\t\tlineNumberSizer.style.display = 'block';\n\n\t\t\t\tconst oneLinerHeight = lineNumberSizer.getBoundingClientRect().height;\n\t\t\t\tlineNumberSizer.innerHTML = '';\n\n\t\t\t\treturn {\n\t\t\t\t\telement,\n\t\t\t\t\tlines: codeLines,\n\t\t\t\t\tlineHeights: [],\n\t\t\t\t\toneLinerHeight,\n\t\t\t\t\tsizer: lineNumberSizer,\n\t\t\t\t\twrapper: lineNumbersWrapper,\n\t\t\t\t};\n\t\t\t})\n\t\t\t.filter(isNonNull)\n\t);\n\n\tinfos.forEach(info => {\n\t\tconst lineNumberSizer = info.sizer;\n\t\tconst lines = info.lines;\n\t\tconst lineHeights = info.lineHeights;\n\t\tconst oneLinerHeight = info.oneLinerHeight;\n\n\t\tlineHeights[lines.length - 1] = undefined;\n\t\tlines.forEach((line, index) => {\n\t\t\tif (line && line.length > 1) {\n\t\t\t\tconst e = lineNumberSizer.appendChild(document.createElement('span'));\n\t\t\t\te.style.display = 'block';\n\t\t\t\te.textContent = line;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tlineHeights[index] = oneLinerHeight;\n\t\t\t}\n\t\t});\n\t});\n\n\tinfos.forEach(info => {\n\t\tconst lineNumberSizer = info.sizer;\n\t\tconst lineHeights = info.lineHeights;\n\n\t\tlet childIndex = 0;\n\t\tfor (let i = 0; i < lineHeights.length; i++) {\n\t\t\tif (lineHeights[i] === undefined) {\n\t\t\t\tlineHeights[i] =\n\t\t\t\t\tlineNumberSizer.children[childIndex++].getBoundingClientRect().height;\n\t\t\t}\n\t\t}\n\t});\n\n\tinfos.forEach(info => {\n\t\tconst lineNumberSizer = info.sizer;\n\n\t\tlineNumberSizer.style.display = 'none';\n\t\tlineNumberSizer.innerHTML = '';\n\n\t\tinfo.lineHeights.forEach((height, lineNumber) => {\n\t\t\tif (height !== undefined) {\n\t\t\t\tconst child = /** @type {HTMLElement} */ (info.wrapper.children[lineNumber]);\n\t\t\t\tchild.style.height = `${height}px`;\n\t\t\t}\n\t\t});\n\t});\n}\n\nexport class LineNumbers {\n\t/**\n\t * Whether the plugin can assume that the units font sizes and margins are not depended on the size of\n\t * the current viewport.\n\t *\n\t * Setting this to `true` will allow the plugin to do certain optimizations for better performance.\n\t *\n\t * Set this to `false` if you use any of the following CSS units: `vh`, `vw`, `vmin`, `vmax`.\n\t */\n\tassumeViewportIndependence = true;\n\n\t/**\n\t * Get node for provided line number\n\t *\n\t * @param {Element} element pre element\n\t * @param {number} number number\n\t * @returns {HTMLElement | undefined}\n\t */\n\tgetLine (element, number) {\n\t\tif (element.tagName !== 'PRE' || !element.classList.contains(PLUGIN_NAME)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst lineNumberRows = getLineNumbersRows(element);\n\t\tif (!lineNumberRows) {\n\t\t\treturn;\n\t\t}\n\t\tconst lineNumberStart = parseInt(String(element.getAttribute('data-start')), 10) || 1;\n\t\tconst lineNumberEnd = lineNumberStart + (lineNumberRows.children.length - 1);\n\n\t\tif (number < lineNumberStart) {\n\t\t\tnumber = lineNumberStart;\n\t\t}\n\t\tif (number > lineNumberEnd) {\n\t\t\tnumber = lineNumberEnd;\n\t\t}\n\n\t\tconst lineIndex = number - lineNumberStart;\n\n\t\treturn /** @type {HTMLElement} */ (lineNumberRows.children[lineIndex]);\n\t}\n\n\t/**\n\t * Returns the nodes of all line numbers.\n\t *\n\t * @param {Element} element pre element\n\t * @returns {HTMLElement[] | undefined}\n\t */\n\tgetLines (element) {\n\t\tif (element.tagName !== 'PRE' || !element.classList.contains(PLUGIN_NAME)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst lineNumberRows = getLineNumbersRows(element);\n\t\tif (!lineNumberRows) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn /** @type {HTMLElement[]} */ ([...lineNumberRows.children]);\n\t}\n\n\t/**\n\t * Resizes the line numbers of the given element.\n\t *\n\t * This function will not add line numbers. It will only resize existing ones.\n\t *\n\t * @param {Element} element A `<pre>` element with line numbers.\n\t * @returns {void}\n\t */\n\tresize (element) {\n\t\tresizeElements([element]);\n\t}\n}\n\n/** @type {import('../../types.d.ts').PluginProto<'line-numbers'>} */\nconst Self = {\n\tid: 'line-numbers',\n\tplugin () {\n\t\treturn new LineNumbers();\n\t},\n\teffect (Prism) {\n\t\tif (typeof document === 'undefined') {\n\t\t\treturn noop;\n\t\t}\n\n\t\tlet lastWidth = NaN;\n\t\tconst listener = () => {\n\t\t\t/** @type {LineNumbers} */\n\t\t\tconst lineNumbers = Prism.pluginRegistry.peek(Self)?.plugin;\n\t\t\tif (lineNumbers.assumeViewportIndependence && lastWidth === window.innerWidth) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tlastWidth = window.innerWidth;\n\n\t\t\tresizeElements([...document.querySelectorAll('pre.' + PLUGIN_NAME)]);\n\t\t};\n\t\twindow.addEventListener('resize', listener);\n\t\tconst removeListener = () => {\n\t\t\twindow.removeEventListener('resize', listener);\n\t\t};\n\n\t\tconst completeHook = Prism.hooks.add('complete', env => {\n\t\t\tif (!env.code) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst code = env.element;\n\t\t\tconst pre = getParentPre(code);\n\n\t\t\t// works only for <code> wrapped inside <pre> (not inline)\n\t\t\tif (!pre) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Abort if line numbers already exists\n\t\t\tif (getLineNumbersRows(code)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// only add line numbers if <code> or one of its ancestors has the `line-numbers` class\n\t\t\tif (!isActive(code, PLUGIN_NAME)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Remove the class 'line-numbers' from the <code>\n\t\t\tcode.classList.remove(PLUGIN_NAME);\n\t\t\t// Add the class 'line-numbers' to the <pre>\n\t\t\tpre.classList.add(PLUGIN_NAME);\n\n\t\t\tconst match = env.code.match(NEW_LINE_EXP);\n\t\t\tconst linesNum = match ? match.length + 1 : 1;\n\n\t\t\tconst lineNumbersWrapper = document.createElement('span');\n\t\t\tlineNumbersWrapper.setAttribute('aria-hidden', 'true');\n\t\t\tlineNumbersWrapper.className = 'line-numbers-rows';\n\t\t\tlineNumbersWrapper.innerHTML = '<span></span>'.repeat(linesNum);\n\n\t\t\tif (pre.hasAttribute('data-start')) {\n\t\t\t\tpre.style.counterReset = `linenumber ${parseInt(String(pre.getAttribute('data-start')), 10) - 1}`;\n\t\t\t}\n\n\t\t\tenv.element.appendChild(lineNumbersWrapper);\n\n\t\t\tresizeElements([pre]);\n\t\t});\n\n\t\treturn combineCallbacks(removeListener, completeHook);\n\t},\n};\n\nexport default Self;\n\nprism.pluginRegistry.add(Self);\n\n/**\n * @typedef {object} Info\n * @property {Element} element\n * @property {string[]} lines\n * @property {(number | undefined)[]} lineHeights\n * @property {number} oneLinerHeight\n * @property {HTMLElement} sizer\n * @property {HTMLElement} wrapper\n */\n"],"names":["PLUGIN_NAME","NEW_LINE_EXP","getLineNumbersRows","element","querySelector","resizeElements","elements","filter","e","whiteSpace","getComputedStyle","length","infos","map","codeElement","lineNumbersWrapper","lineNumberSizer","codeLines","textContent","split","document","createElement","className","appendChild","innerHTML","style","display","oneLinerHeight","getBoundingClientRect","height","lines","lineHeights","sizer","wrapper","isNonNull","forEach","info","undefined","line","index","childIndex","i","children","lineNumber","LineNumbers","assumeViewportIndependence","getLine","number","tagName","classList","contains","lineNumberRows","lineNumberStart","parseInt","getAttribute","String","lineNumberEnd","lineIndex","getLines","resize","Self","id","plugin","effect","Prism","noop","lastWidth","NaN","listener","lineNumbers","pluginRegistry","peek","window","innerWidth","querySelectorAll","addEventListener","completeHook","hooks","add","env","code","pre","getParentPre","isActive","remove","match","linesNum","setAttribute","repeat","hasAttribute","counterReset","combineCallbacks","removeEventListener","prism"],"mappings":"kPAQA,MAAMA,EAAc,eAKdC,EAAe,WAQrB,SAASC,EAAoBC,GAC5B,OAAOA,EAAQC,cAAc,qBAC9B,CAOA,SAASC,EAAgBC,GAOxB,GAAwB,KANxBA,EAAWA,EAASC,QAAOC,IAC1B,MACMC,EADaC,iBAAiBF,GACNC,WAC9B,MAAsB,aAAfA,GAA4C,aAAfA,CAAyB,KAGjDE,OACZ,OAGD,MAAMC,EACLN,EACEO,KAAIV,IACJ,MAAMW,EAAcX,EAAQC,cAAc,QACpCW,EAAqBb,EAAmBC,GAC9C,IAAKW,IAAgBC,EACpB,OAID,IAAIC,EAAkBb,EAAQC,cAAc,uBAE5C,MAAMa,EAAYH,EAAYI,YAAYC,MAAMlB,GAE3Ce,IACJA,EAAkBI,SAASC,cAAc,QACzCL,EAAgBM,UAAY,qBAE5BR,EAAYS,YAAYP,IAGzBA,EAAgBQ,UAAY,IAC5BR,EAAgBS,MAAMC,QAAU,QAEhC,MAAMC,EAAiBX,EAAgBY,wBAAwBC,OAG/D,OAFAb,EAAgBQ,UAAY,GAErB,CACNrB,UACA2B,MAAOb,EACPc,YAAa,GACbJ,iBACAK,MAAOhB,EACPiB,QAASlB,EACT,IAEDR,OAAO2B,GAGVtB,EAAMuB,SAAQC,IACb,MAAMpB,EAAkBoB,EAAKJ,MACvBF,EAAQM,EAAKN,MACbC,EAAcK,EAAKL,YACnBJ,EAAiBS,EAAKT,eAE5BI,EAAYD,EAAMnB,OAAS,QAAK0B,EAChCP,EAAMK,SAAQ,CAACG,EAAMC,KACpB,GAAID,GAAQA,EAAK3B,OAAS,EAAG,CAC5B,MAAMH,EAAIQ,EAAgBO,YAAYH,SAASC,cAAc,SAC7Db,EAAEiB,MAAMC,QAAU,QAClBlB,EAAEU,YAAcoB,CACpB,MAEIP,EAAYQ,GAASZ,CACzB,GACI,IAGHf,EAAMuB,SAAQC,IACb,MAAMpB,EAAkBoB,EAAKJ,MACvBD,EAAcK,EAAKL,YAEzB,IAAIS,EAAa,EACjB,IAAK,IAAIC,EAAI,EAAGA,EAAIV,EAAYpB,OAAQ8B,SAChBJ,IAAnBN,EAAYU,KACfV,EAAYU,GACXzB,EAAgB0B,SAASF,KAAcZ,wBAAwBC,OAEpE,IAGCjB,EAAMuB,SAAQC,IACb,MAAMpB,EAAkBoB,EAAKJ,MAE7BhB,EAAgBS,MAAMC,QAAU,OAChCV,EAAgBQ,UAAY,GAE5BY,EAAKL,YAAYI,SAAQ,CAACN,EAAQc,UAClBN,IAAXR,IACuCO,EAAKH,QAAQS,SAASC,GAC1DlB,MAAMI,OAAYA,EAAH,KACzB,GACI,GAEJ,CAEO,MAAMe,YASZC,4BAA6B,EAS7B,OAAAC,CAAS3C,EAAS4C,GACjB,GAAwB,QAApB5C,EAAQ6C,UAAsB7C,EAAQ8C,UAAUC,SAASlD,GAC5D,OAGD,MAAMmD,EAAiBjD,EAAmBC,GAC1C,IAAKgD,EACJ,OAED,MAAMC,EAAkBC,SAAgBlD,EAAQmD,aAAa,cAA5BC,GAA4C,KAAO,EAC9EC,EAAgBJ,GAAmBD,EAAeT,SAAS/B,OAAS,GAEtEoC,EAASK,IACZL,EAASK,GAENL,EAASS,IACZT,EAASS,GAGV,MAAMC,EAAYV,EAASK,EAE3B,OAAmCD,EAAeT,SAASe,EAC7D,CAQC,QAAAC,CAAUvD,GACT,GAAwB,QAApBA,EAAQ6C,UAAsB7C,EAAQ8C,UAAUC,SAASlD,GAC5D,OAGD,MAAMmD,EAAiBjD,EAAmBC,GAC1C,OAAKgD,MAIoCA,EAAeT,eAJxD,CAKF,CAUC,MAAAiB,CAAQxD,GACPE,EAAe,CAACF,GAClB,EAIK,MAACyD,EAAO,CACZC,GAAI,eACJC,OAAO,IACC,IAAIlB,YAEZ,MAAAmB,CAAQC,GACP,GAAwB,oBAAb5C,SACV,OAAO6C,EAGR,IAAIC,EAAYC,IAChB,MAAMC,EAAW,KAEhB,MAAMC,EAAcL,EAAMM,eAAeC,KAAKX,IAAOE,OACjDO,EAAYxB,4BAA8BqB,IAAcM,OAAOC,aAGnEP,EAAYM,OAAOC,WAEnBpE,EAAe,IAAIe,SAASsD,iBAAiB,OAAS1E,KAAc,EAErEwE,OAAOG,iBAAiB,SAAUP,GAClC,MAIMQ,EAAeZ,EAAMa,MAAMC,IAAI,YAAYC,IAChD,IAAKA,EAAIC,KACR,OAGD,MAAMA,EAAOD,EAAI5E,QACX8E,EAAMC,EAAaF,GAGzB,IAAKC,EACJ,OAID,GAAI/E,EAAmB8E,GACtB,OAID,IAAKG,EAASH,EAAMhF,GACnB,OAIDgF,EAAK/B,UAAUmC,OAAOpF,GAEtBiF,EAAIhC,UAAU6B,IAAI9E,GAElB,MAAMqF,EAAQN,EAAIC,KAAKK,MAAMpF,GACvBqF,EAAWD,EAAQA,EAAM1E,OAAS,EAAI,EAEtCI,EAAqBK,SAASC,cAAc,QAClDN,EAAmBwE,aAAa,cAAe,QAC/CxE,EAAmBO,UAAY,oBAC/BP,EAAmBS,UAAY,gBAAgBgE,OAAOF,GAElDL,EAAIQ,aAAa,gBACpBR,EAAIxD,MAAMiE,aAAe,eAAcrC,SAAgB4B,EAAI3B,aAAa,cAAxBC,GAAwC,IAAM,IAG/FwB,EAAI5E,QAAQoB,YAAYR,GAExBV,EAAe,CAAC4E,GAAK,IAGtB,OAAOU,GAjDgB,KACtBnB,OAAOoB,oBAAoB,SAAUxB,EAAS,GAgDPQ,EACxC,GAKFiB,EAAMvB,eAAeQ,IAAIlB"}