{"version":3,"file":"normalize-whitespace.js","sources":["../../src/plugins/normalize-whitespace/normalize-whitespace.js"],"sourcesContent":["import prism from '../../global.js';\nimport { getParentPre, isActive } from '../../shared/dom-util.js';\n\n/**\n * @param {string} str\n * @returns {number}\n */\nfunction tabLength (str) {\n\tlet res = 0;\n\tfor (let i = 0; i < str.length; ++i) {\n\t\tif (str.charCodeAt(i) === '\\t'.charCodeAt(0)) {\n\t\t\tres += 3;\n\t\t}\n\t}\n\treturn str.length + res;\n}\n\n/** @type {(keyof NormalizeWhitespaceDefaults)[]} */\nconst normalizationOrder = [\n\t'remove-trailing',\n\t'remove-indent',\n\t'left-trim',\n\t'right-trim',\n\t'break-lines',\n\t'indent',\n\t'remove-initial-line-feed',\n\t'tabs-to-spaces',\n\t'spaces-to-tabs',\n];\n\nconst settingsConfig = {\n\t'remove-trailing': 'boolean',\n\t'remove-indent': 'boolean',\n\t'left-trim': 'boolean',\n\t'right-trim': 'boolean',\n\t'break-lines': 'number',\n\t'indent': 'number',\n\t'remove-initial-line-feed': 'boolean',\n\t'tabs-to-spaces': 'number',\n\t'spaces-to-tabs': 'number',\n};\n\n/**\n * Reads normalizations settings from the given elements's `data-*` attributes.\n *\n * @param {Element} element\n */\nfunction readSetting (element) {\n\tconst settings = {};\n\tfor (const key of normalizationOrder) {\n\t\tconst attr = element.getAttribute('data-' + key);\n\t\tconst type = settingsConfig[key];\n\t\tif (attr !== null) {\n\t\t\ttry {\n\t\t\t\tconst value = JSON.parse(attr || 'true');\n\t\t\t\tif (typeof value === type) {\n\t\t\t\t\tsettings[key] = value;\n\t\t\t\t}\n\t\t\t}\n\t\t\tcatch {\n\t\t\t\t// ignore error\n\t\t\t}\n\t\t}\n\t}\n\treturn settings;\n}\n\nconst normalizationMethods = {\n\t'left-trim': input => input.replace(/^\\s+/, ''),\n\t'right-trim': input => input.replace(/(^|\\S)\\s+$/, '$1'),\n\t'tabs-to-spaces': (input, spaces) => input.replace(/\\t/g, ' '.repeat(spaces)),\n\t'spaces-to-tabs': (input, spaces) => input.replace(RegExp(` {${spaces}}`, 'g'), '\\t'),\n\t'remove-trailing': input => input.replace(/\\s*?$/gm, ''),\n\t'remove-initial-line-feed': input => input.replace(/^(?:\\r?\\n|\\r)/, ''),\n\t'remove-indent': input => {\n\t\tconst indents = input.match(/^[^\\S\\n\\r]*(?=\\S)/gm);\n\n\t\tif (!indents || !indents[0].length) {\n\t\t\treturn input;\n\t\t}\n\n\t\tindents.sort((a, b) => a.length - b.length);\n\n\t\tif (!indents[0].length) {\n\t\t\treturn input;\n\t\t}\n\n\t\treturn input.replace(RegExp('^' + indents[0], 'gm'), '');\n\t},\n\t'indent': (input, tabs) => input.replace(/^[^\\S\\n\\r]*(?=\\S)/gm, '\\t'.repeat(tabs) + '$&'),\n\t'break-lines': (input, characters) => {\n\t\tconst lines = input.split('\\n');\n\t\tfor (let i = 0; i < lines.length; ++i) {\n\t\t\tif (tabLength(lines[i]) <= characters) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst line = lines[i].split(/(\\s+)/);\n\t\t\tlet len = 0;\n\n\t\t\tfor (let j = 0; j < line.length; ++j) {\n\t\t\t\tconst tl = tabLength(line[j]);\n\t\t\t\tlen += tl;\n\t\t\t\tif (len > characters) {\n\t\t\t\t\tline[j] = '\\n' + line[j];\n\t\t\t\t\tlen = tl;\n\t\t\t\t}\n\t\t\t}\n\t\t\tlines[i] = line.join('');\n\t\t}\n\t\treturn lines.join('\\n');\n\t},\n};\n\nexport class NormalizeWhitespace {\n\tdefaults;\n\tconstructor (defaults) {\n\t\tthis.defaults = { ...defaults };\n\t}\n\n\tsetDefaults (defaults) {\n\t\tObject.assign(this.defaults, defaults);\n\t}\n\n\t/**\n\t * @param {string} input\n\t * @param {object} [settings]\n\t * @returns {string}\n\t */\n\tnormalize (input, settings) {\n\t\tsettings = { ...this.defaults, ...settings };\n\n\t\tfor (const name of normalizationOrder) {\n\t\t\tconst value = settings[name];\n\t\t\tif (value !== undefined && value !== false) {\n\t\t\t\tinput = normalizationMethods[name](input, value);\n\t\t\t}\n\t\t}\n\n\t\treturn input;\n\t}\n}\n\n/** @type {import('../../types.d.ts').PluginProto<'normalize-whitespace'>} */\nconst Self = {\n\tid: 'normalize-whitespace',\n\toptional: 'unescaped-markup',\n\tplugin () {\n\t\treturn new NormalizeWhitespace({\n\t\t\t'remove-trailing': true,\n\t\t\t'remove-indent': true,\n\t\t\t'left-trim': true,\n\t\t\t'right-trim': true,\n\t\t\t/*'break-lines': 80,\n\t\t\t\t'indent': 2,\n\t\t\t\t'remove-initial-line-feed': false,\n\t\t\t\t'tabs-to-spaces': 4,\n\t\t\t\t'spaces-to-tabs': 4*/\n\t\t});\n\t},\n\teffect (Prism) {\n\t\t/** @type {NormalizeWhitespace} */\n\t\tconst Normalizer = Prism.pluginRegistry.peek(Self)?.plugin;\n\n\t\treturn Prism.hooks.add('before-sanity-check', env => {\n\t\t\tif (!env.code) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Check classes\n\t\t\tif (!isActive(env.element, 'whitespace-normalization', true)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Simple mode if there is no env.element\n\t\t\tif (!env.element.parentNode) {\n\t\t\t\tenv.code = Normalizer.normalize(env.code);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Normal mode\n\t\t\tconst pre = getParentPre(env.element);\n\t\t\tif (!pre) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst settings = readSetting(pre);\n\n\t\t\tconst children = pre.childNodes;\n\t\t\tlet before = '';\n\t\t\tlet after = '';\n\t\t\tlet codeFound = false;\n\n\t\t\t// Move surrounding whitespace from the <pre> tag into the <code> tag\n\t\t\tfor (let i = 0; i < children.length; ++i) {\n\t\t\t\tconst node = children[i];\n\n\t\t\t\tif (node === env.element) {\n\t\t\t\t\tcodeFound = true;\n\t\t\t\t}\n\t\t\t\telse if (node.nodeName === '#text') {\n\t\t\t\t\tif (codeFound) {\n\t\t\t\t\t\tafter += node.nodeValue;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tbefore += node.nodeValue;\n\t\t\t\t\t}\n\n\t\t\t\t\tpre.removeChild(node);\n\t\t\t\t\t--i;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (!env.element.children.length || !Prism.pluginRegistry.has('keep-markup')) {\n\t\t\t\tenv.code = before + env.code + after;\n\t\t\t\tenv.code = Normalizer.normalize(env.code, settings);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Preserve markup for keep-markup plugin\n\t\t\t\tconst html = before + env.element.innerHTML + after;\n\t\t\t\tenv.element.innerHTML = Normalizer.normalize(html, settings);\n\t\t\t\tenv.code = env.element.textContent || '';\n\t\t\t}\n\t\t});\n\t},\n};\n\nexport default Self;\n\nprism.pluginRegistry.add(Self);\n\n/**\n * @typedef {object} NormalizeWhitespaceDefaults\n * @property {number} break-lines\n * @property {number} indent\n * @property {boolean} left-trim\n * @property {boolean} remove-indent\n * @property {boolean} remove-initial-line-feed\n * @property {boolean} remove-trailing\n * @property {boolean} right-trim\n * @property {number} spaces-to-tabs\n * @property {number} tabs-to-spaces\n */\n"],"names":["tabLength","str","res","i","length","charCodeAt","normalizationOrder","settingsConfig","indent","normalizationMethods","input","replace","spaces","repeat","RegExp","indents","match","sort","a","b","tabs","characters","lines","split","line","len","j","tl","join","NormalizeWhitespace","defaults","constructor","this","setDefaults","Object","assign","normalize","settings","name","value","undefined","Self","id","optional","plugin","effect","Prism","Normalizer","pluginRegistry","peek","hooks","add","env","code","isActive","element","parentNode","pre","getParentPre","key","attr","getAttribute","type","JSON","parse","readSetting","children","childNodes","before","after","codeFound","node","nodeName","nodeValue","removeChild","has","html","innerHTML","textContent","prism"],"mappings":"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"}