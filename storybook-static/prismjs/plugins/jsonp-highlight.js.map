{"version":3,"file":"jsonp-highlight.js","sources":["../../src/plugins/jsonp-highlight/jsonp-highlight.js"],"sourcesContent":["import prism from '../../global.js';\n\nfunction getGlobal () {\n\treturn typeof window === 'object' ? window : {};\n}\n\nlet jsonpCallbackCounter = 0;\n\n/**\n * Makes a JSONP request.\n *\n * @param {string} src The URL of the resource to request.\n * @param {string | undefined | null} callbackParameter The name of the callback parameter. If falsy, `\"callback\"` will be used.\n * @param {number} timeout\n * @param {(data: any) => void} onSuccess\n * @param {(reason: 'timeout' | 'network') => void} onError\n * @returns {void}\n */\nfunction jsonp (src, callbackParameter, timeout, onSuccess, onError) {\n\tconst callbackName = `prismjsonp${jsonpCallbackCounter++}`;\n\n\tconst uri = document.createElement('a');\n\turi.href = src;\n\turi.href += (uri.search ? '&' : '?') + (callbackParameter || 'callback') + '=' + callbackName;\n\n\tconst script = document.createElement('script');\n\tscript.src = uri.href;\n\tscript.onerror = function () {\n\t\tcleanup();\n\t\tonError('network');\n\t};\n\n\tconst timeoutId = setTimeout(() => {\n\t\tcleanup();\n\t\tonError('timeout');\n\t}, timeout);\n\n\tconst global = getGlobal();\n\n\tfunction cleanup () {\n\t\tclearTimeout(timeoutId);\n\t\tdocument.head.removeChild(script);\n\t\tdelete global[callbackName];\n\t}\n\n\t/**\n\t * The JSONP callback function\n\t */\n\tglobal[callbackName] = response => {\n\t\tcleanup();\n\t\tonSuccess(response);\n\t};\n\n\tdocument.head.appendChild(script);\n}\n\nconst STATUS_ATTR = 'data-jsonp-status';\nconst STATUS_LOADING = 'loading';\nconst STATUS_LOADED = 'loaded';\nconst STATUS_FAILED = 'failed';\n\nconst SELECTOR =\n\t'pre[data-jsonp]:not([' +\n\tSTATUS_ATTR +\n\t'=\"' +\n\tSTATUS_LOADED +\n\t'\"])' +\n\t':not([' +\n\tSTATUS_ATTR +\n\t'=\"' +\n\tSTATUS_LOADING +\n\t'\"])';\n\nexport class JsonpHighlight {\n\t/**\n\t * The timeout after which an error message will be displayed.\n\t *\n\t * __Note:__ If the request succeeds after the timeout, it will still be processed and will override any\n\t * displayed error messages.\n\t */\n\ttimeout = 5000;\n\n\t/**\n\t * @type {Prism}\n\t */\n\tPrism;\n\n\t/**\n\t * The list of adapter which will be used if `data-adapter` is not specified.\n\t *\n\t * @type {{ adapter: Adapter, name: string }[]}\n\t */\n\tadapters = [];\n\n\t/**\n\t * @param {Prism} Prism\n\t */\n\tconstructor (Prism) {\n\t\tthis.Prism = Prism;\n\t}\n\n\t/**\n\t * Returns the given adapter itself, if registered, or a registered adapter with the given name.\n\t *\n\t * If no fitting adapter is registered, `null` will be returned.\n\t *\n\t * @param {string | Adapter} adapter The adapter itself or the name of an adapter.\n\t */\n\tgetAdapter (adapter) {\n\t\tif (typeof adapter === 'function') {\n\t\t\tfor (const item of this.adapters) {\n\t\t\t\tif (item.adapter.valueOf() === adapter.valueOf()) {\n\t\t\t\t\treturn item.adapter;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\telse if (typeof adapter === 'string') {\n\t\t\tfor (const item of this.adapters) {\n\t\t\t\tif (item.name === adapter) {\n\t\t\t\t\treturn item.adapter;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t}\n\n\t/**\n\t * Adds a new function to the list of adapters.\n\t *\n\t * If the given adapter is already registered or not a function or there is an adapter with the given name already,\n\t * nothing will happen.\n\t *\n\t * @param {string} name The name of the adapter.\n\t * @param {Adapter} adapter The adapter to be registered.\n\t */\n\tregisterAdapter (name, adapter) {\n\t\tif (typeof adapter === 'function' && !this.getAdapter(adapter) && !this.getAdapter(name)) {\n\t\t\tthis.adapters.push({ adapter, name });\n\t\t}\n\t}\n\n\t/**\n\t * Remove the given adapter or the first registered adapter with the given name from the list of\n\t * registered adapters.\n\t *\n\t * @param {string | Adapter} adapter The adapter itself or the name of an adapter.\n\t */\n\tremoveAdapter (adapter) {\n\t\tconst resolvedAdapter = typeof adapter === 'string' ? this.getAdapter(adapter) : adapter;\n\t\tif (resolvedAdapter) {\n\t\t\tconst index = this.adapters.findIndex(item => item.adapter === resolvedAdapter);\n\t\t\tif (index >= 0) {\n\t\t\t\tthis.adapters.splice(index, 1);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Runs all registered adapters in the order they were registered using\n\t * the given arguments. The result of the first adapter that returns a\n\t * string will be returned and iteration will be stopped.\n\t *\n\t * @param {Parameters<Adapter>} args\n\t */\n\trunAdapters (...args) {\n\t\tfor (const adapter of this.adapters) {\n\t\t\tconst data = adapter.adapter(...args);\n\t\t\tif (data !== null) {\n\t\t\t\treturn data;\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t}\n\n\t/**\n\t * Highlights all `pre` elements under the given container with a `data-jsonp` attribute by requesting the\n\t * specified JSON and using the specified adapter or a registered adapter to extract the code to highlight\n\t * from the response. The highlighted code will be inserted into the `pre` element.\n\t *\n\t * Note: Elements which are already loaded or currently loading will not be touched by this method.\n\t *\n\t * @param {Element | Document} [container=document] Defaults to `document`.\n\t */\n\thighlight (container = document) {\n\t\tconst elements = container.querySelectorAll(SELECTOR);\n\n\t\tfor (const element of elements) {\n\t\t\tthis.Prism.highlightElement(element);\n\t\t}\n\t}\n}\n\n/** @type {import('../../types.d.ts').PluginProto<'jsonp-highlight'>} */\nconst Self = {\n\tid: 'jsonp-highlight',\n\tplugin (Prism) {\n\t\tconst config = new JsonpHighlight(Prism);\n\n\t\tconfig.registerAdapter('github', rsp => {\n\t\t\tif (rsp && rsp.meta && rsp.data) {\n\t\t\t\tif (rsp.meta.status && rsp.meta.status >= 400) {\n\t\t\t\t\treturn `Error: ${rsp.data.message || rsp.meta.status}`;\n\t\t\t\t}\n\t\t\t\telse if (typeof rsp.data.content === 'string') {\n\t\t\t\t\treturn typeof atob === 'function'\n\t\t\t\t\t\t? atob(rsp.data.content.replace(/\\s/g, ''))\n\t\t\t\t\t\t: 'Your browser cannot decode base64';\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn null;\n\t\t});\n\t\tconfig.registerAdapter('gist', (rsp, el) => {\n\t\t\tif (rsp && rsp.meta && rsp.data && rsp.data.files) {\n\t\t\t\tif (rsp.meta.status && rsp.meta.status >= 400) {\n\t\t\t\t\treturn `Error: ${rsp.data.message || rsp.meta.status}`;\n\t\t\t\t}\n\n\t\t\t\tconst files = rsp.data.files;\n\t\t\t\tlet filename = el.getAttribute('data-filename');\n\t\t\t\tif (filename == null) {\n\t\t\t\t\t// Maybe in the future we can somehow render all files\n\t\t\t\t\t// But the standard <script> include for gists does that nicely already,\n\t\t\t\t\t// so that might be getting beyond the scope of this plugin\n\t\t\t\t\tfor (const key in files) {\n\t\t\t\t\t\tif (files.hasOwnProperty(key)) {\n\t\t\t\t\t\t\tfilename = key;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (filename && files[filename] !== undefined) {\n\t\t\t\t\treturn String(files[filename].content);\n\t\t\t\t}\n\t\t\t\treturn `Error: unknown or missing gist file ${filename}`;\n\t\t\t}\n\t\t\treturn null;\n\t\t});\n\t\tconfig.registerAdapter('bitbucket', rsp => {\n\t\t\tif (rsp && rsp.node && typeof rsp.data === 'string') {\n\t\t\t\treturn String(rsp.data);\n\t\t\t}\n\t\t\treturn null;\n\t\t});\n\n\t\treturn config;\n\t},\n\teffect (Prism) {\n\t\t/** @type {JsonpHighlight} */\n\t\tconst config = Prism.pluginRegistry.peek(Self)?.plugin;\n\n\t\tconst LOADING_MESSAGE = 'Loading…';\n\t\t/** @param {string} name */\n\t\tconst MISSING_ADAPTER_MESSAGE = name => {\n\t\t\treturn '✖ Error: JSONP adapter function \"' + name + '\" doesn\\'t exist';\n\t\t};\n\t\t/** @param {string} url */\n\t\tconst TIMEOUT_MESSAGE = url => {\n\t\t\treturn '✖ Error: Timeout loading ' + url;\n\t\t};\n\t\tconst UNKNOWN_FAILURE_MESSAGE =\n\t\t\t'✖ Error: Cannot parse response (perhaps you need an adapter function?)';\n\n\t\treturn Prism.hooks.add({\n\t\t\t'before-highlightall': env => {\n\t\t\t\tenv.selector += ', ' + SELECTOR;\n\t\t\t},\n\t\t\t'before-sanity-check': env => {\n\t\t\t\t/** @type {HTMLPreElement} */\n\t\t\t\tconst pre = env.element;\n\t\t\t\tif (!pre.matches(SELECTOR)) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst src = pre.getAttribute('data-jsonp');\n\t\t\t\tif (!src) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tenv.code = ''; // fast-path the whole thing and go to complete\n\n\t\t\t\t// mark as loading\n\t\t\t\tpre.setAttribute(STATUS_ATTR, STATUS_LOADING);\n\n\t\t\t\t// add code element with loading message\n\t\t\t\tconst code = pre.appendChild(document.createElement('CODE'));\n\t\t\t\tcode.textContent = LOADING_MESSAGE;\n\n\t\t\t\t// set language\n\t\t\t\tconst language = env.language;\n\t\t\t\tcode.className = 'language-' + language;\n\n\t\t\t\t// preload the language\n\t\t\t\t/** @type {import('../autoloader/autoloader.js').Autoloader} */\n\t\t\t\tconst autoloader = Prism.pluginRegistry.peek('autoloader')?.plugin;\n\t\t\t\tif (autoloader) {\n\t\t\t\t\tautoloader.preloadLanguages(language);\n\t\t\t\t}\n\n\t\t\t\tconst adapterName = pre.getAttribute('data-adapter');\n\t\t\t\t/** @type {Adapter | null} */\n\t\t\t\tlet adapter = null;\n\t\t\t\tif (adapterName) {\n\t\t\t\t\tconst global = getGlobal();\n\t\t\t\t\tif (typeof global[adapterName] === 'function') {\n\t\t\t\t\t\t/** @type {Adapter} */\n\t\t\t\t\t\tadapter = global[adapterName];\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\t// mark as failed\n\t\t\t\t\t\tpre.setAttribute(STATUS_ATTR, STATUS_FAILED);\n\n\t\t\t\t\t\tcode.textContent = MISSING_ADAPTER_MESSAGE(adapterName);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tjsonp(\n\t\t\t\t\tsrc,\n\t\t\t\t\tpre.getAttribute('data-callback'),\n\t\t\t\t\tconfig.timeout,\n\t\t\t\t\tresponse => {\n\t\t\t\t\t\t// interpret the received data using the adapter(s)\n\t\t\t\t\t\tlet data;\n\t\t\t\t\t\tif (adapter) {\n\t\t\t\t\t\t\tdata = adapter(response, pre);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tdata = config.runAdapters(response, pre);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (data === null) {\n\t\t\t\t\t\t\t// mark as failed\n\t\t\t\t\t\t\tpre.setAttribute(STATUS_ATTR, STATUS_FAILED);\n\n\t\t\t\t\t\t\tcode.textContent = UNKNOWN_FAILURE_MESSAGE;\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t// mark as loaded\n\t\t\t\t\t\t\tpre.setAttribute(STATUS_ATTR, STATUS_LOADED);\n\n\t\t\t\t\t\t\tcode.textContent = data;\n\t\t\t\t\t\t\tPrism.highlightElement(code);\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\t() => {\n\t\t\t\t\t\t// mark as failed\n\t\t\t\t\t\tpre.setAttribute(STATUS_ATTR, STATUS_FAILED);\n\n\t\t\t\t\t\tcode.textContent = TIMEOUT_MESSAGE(src);\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t},\n\t\t});\n\t},\n};\n\nexport default Self;\n\nprism.pluginRegistry.add(Self);\n\n/**\n * @callback Adapter\n * @param {any} response\n * @param {HTMLPreElement} pre\n * @returns {string | null}\n */\n\n/**\n * @typedef {import('../../core.js').Prism} Prism\n */\n"],"names":["getGlobal","window","jsonpCallbackCounter","STATUS_ATTR","STATUS_LOADING","STATUS_LOADED","STATUS_FAILED","SELECTOR","JsonpHighlight","timeout","Prism","adapters","constructor","this","getAdapter","adapter","item","valueOf","name","registerAdapter","push","removeAdapter","resolvedAdapter","index","findIndex","splice","runAdapters","args","data","highlight","container","document","elements","querySelectorAll","element","highlightElement","Self","id","plugin","config","rsp","meta","status","message","content","atob","replace","el","files","filename","getAttribute","key","hasOwnProperty","undefined","String","node","effect","pluginRegistry","peek","hooks","add","env","selector","pre","matches","src","code","setAttribute","appendChild","createElement","textContent","language","className","autoloader","preloadLanguages","adapterName","global","callbackParameter","onSuccess","onError","callbackName","uri","href","search","script","onerror","cleanup","timeoutId","setTimeout","clearTimeout","head","removeChild","response","jsonp","prism"],"mappings":"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"}