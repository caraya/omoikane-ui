{"version":3,"file":"command-line.js","sources":["../../src/plugins/command-line/command-line.js"],"sourcesContent":["import prism from '../../global.js';\nimport { getParentPre } from '../../shared/dom-util.js';\nimport { htmlEncode } from '../../shared/util.js';\n\nconst CLASS_PATTERN = /(?:^|\\s)command-line(?:\\s|$)/;\nconst PROMPT_CLASS = 'command-line-prompt';\n\n/** @type {import('../../types.d.ts').PluginProto<'command-line'>} */\nconst Self = {\n\tid: 'command-line',\n\teffect (Prism) {\n\t\treturn Prism.hooks.add({\n\t\t\t'before-highlight': env => {\n\t\t\t\tconst commandLine = (env.commandLine ??= {});\n\n\t\t\t\tif (commandLine.complete || !env.code) {\n\t\t\t\t\tcommandLine.complete = true;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Works only for <code> wrapped inside <pre> (not inline).\n\t\t\t\tconst pre = getParentPre(env.element);\n\t\t\t\tif (\n\t\t\t\t\t!pre || // Abort only if neither the <pre> nor the <code> have the class\n\t\t\t\t\t(!CLASS_PATTERN.test(pre.className) &&\n\t\t\t\t\t\t!CLASS_PATTERN.test(env.element.className))\n\t\t\t\t) {\n\t\t\t\t\tcommandLine.complete = true;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// The element might be highlighted multiple times, so we just remove the previous prompt\n\t\t\t\tconst existingPrompt = env.element.querySelector('.' + PROMPT_CLASS);\n\t\t\t\tif (existingPrompt) {\n\t\t\t\t\texistingPrompt.remove();\n\t\t\t\t}\n\n\t\t\t\tconst codeLines = env.code.split('\\n');\n\n\t\t\t\tcommandLine.numberOfLines = codeLines.length;\n\t\t\t\tconst outputLines = (commandLine.outputLines = []);\n\n\t\t\t\tconst outputSections = pre.getAttribute('data-output');\n\t\t\t\tconst outputFilter = pre.getAttribute('data-filter-output');\n\t\t\t\tif (outputSections !== null) {\n\t\t\t\t\t// The user specified the output lines. -- cwells\n\t\t\t\t\toutputSections.split(',').forEach(section => {\n\t\t\t\t\t\tconst range = section.split('-');\n\t\t\t\t\t\tlet outputStart = parseInt(range[0], 10);\n\t\t\t\t\t\tlet outputEnd = range.length === 2 ? parseInt(range[1], 10) : outputStart;\n\n\t\t\t\t\t\tif (!isNaN(outputStart) && !isNaN(outputEnd)) {\n\t\t\t\t\t\t\tif (outputStart < 1) {\n\t\t\t\t\t\t\t\toutputStart = 1;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (outputEnd > codeLines.length) {\n\t\t\t\t\t\t\t\toutputEnd = codeLines.length;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t// Convert start and end to 0-based to simplify the arrays. -- cwells\n\t\t\t\t\t\t\toutputStart--;\n\t\t\t\t\t\t\toutputEnd--;\n\t\t\t\t\t\t\t// Save the output line in an array and clear it in the code so it's not highlighted. -- cwells\n\t\t\t\t\t\t\tfor (let j = outputStart; j <= outputEnd; j++) {\n\t\t\t\t\t\t\t\toutputLines[j] = codeLines[j];\n\t\t\t\t\t\t\t\tcodeLines[j] = '';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\telse if (outputFilter) {\n\t\t\t\t\t// Treat lines beginning with this string as output. -- cwells\n\t\t\t\t\tfor (let i = 0; i < codeLines.length; i++) {\n\t\t\t\t\t\tif (codeLines[i].startsWith(outputFilter)) {\n\t\t\t\t\t\t\t// This line is output. -- cwells\n\t\t\t\t\t\t\toutputLines[i] = codeLines[i].slice(outputFilter.length);\n\t\t\t\t\t\t\tcodeLines[i] = '';\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tconst continuationLineIndicies = (commandLine.continuationLineIndicies = new Set());\n\t\t\t\tconst lineContinuationStr = pre.getAttribute('data-continuation-str');\n\t\t\t\tconst continuationFilter = pre.getAttribute('data-filter-continuation');\n\n\t\t\t\t// Identify code lines where the command has continued onto subsequent\n\t\t\t\t// lines and thus need a different prompt. Need to do this after the output\n\t\t\t\t// lines have been removed to ensure we don't pick up a continuation string\n\t\t\t\t// in an output line.\n\t\t\t\tfor (let j = 0; j < codeLines.length; j++) {\n\t\t\t\t\tconst line = codeLines[j];\n\t\t\t\t\tif (!line) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Record the next line as a continuation if this one ends in a continuation str.\n\t\t\t\t\tif (lineContinuationStr && line.endsWith(lineContinuationStr)) {\n\t\t\t\t\t\tcontinuationLineIndicies.add(j + 1);\n\t\t\t\t\t}\n\t\t\t\t\t// Record this line as a continuation if marked with a continuation prefix\n\t\t\t\t\t// (that we will remove).\n\t\t\t\t\tif (j > 0 && continuationFilter && line.startsWith(continuationFilter)) {\n\t\t\t\t\t\tcodeLines[j] = line.slice(continuationFilter.length);\n\t\t\t\t\t\tcontinuationLineIndicies.add(j);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tenv.code = codeLines.join('\\n');\n\t\t\t},\n\t\t\t'before-insert': env => {\n\t\t\t\tconst commandLine = (env.commandLine ??= {});\n\t\t\t\tif (commandLine.complete) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Reinsert the output lines into the highlighted code. -- cwells\n\t\t\t\tconst codeLines = env.highlightedCode.split('\\n');\n\t\t\t\tconst outputLines = commandLine.outputLines || [];\n\t\t\t\tfor (let i = 0, l = codeLines.length; i < l; i++) {\n\t\t\t\t\t// Add spans to allow distinction of input/output text for styling\n\t\t\t\t\tif (outputLines.hasOwnProperty(i)) {\n\t\t\t\t\t\t// outputLines were removed from codeLines so missed out on escaping\n\t\t\t\t\t\t// of markup so do it here.\n\t\t\t\t\t\tcodeLines[i] =\n\t\t\t\t\t\t\t'<span class=\"token output\">' + htmlEncode(outputLines[i]) + '</span>';\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tcodeLines[i] = '<span class=\"token command\">' + codeLines[i] + '</span>';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tenv.highlightedCode = codeLines.join('\\n');\n\t\t\t},\n\t\t\t'complete': env => {\n\t\t\t\tconst commandLine = (env.commandLine ??= {});\n\t\t\t\tif (commandLine.complete) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst pre = getParentPre(env.element);\n\t\t\t\tif (!pre) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tif (CLASS_PATTERN.test(env.element.className)) {\n\t\t\t\t\t// Remove the class \"command-line\" from the <code>\n\t\t\t\t\tenv.element.className = env.element.className.replace(CLASS_PATTERN, ' ');\n\t\t\t\t}\n\t\t\t\tif (!CLASS_PATTERN.test(pre.className)) {\n\t\t\t\t\t// Add the class \"command-line\" to the <pre>\n\t\t\t\t\tpre.className += ' command-line';\n\t\t\t\t}\n\n\t\t\t\t/**\n\t\t\t\t * @param {string} key\n\t\t\t\t * @param {string} defaultValue\n\t\t\t\t * @returns {string}\n\t\t\t\t */\n\t\t\t\tconst getAttribute = (key, defaultValue) => {\n\t\t\t\t\treturn (pre.getAttribute(key) || defaultValue).replace(/\"/g, '&quot');\n\t\t\t\t};\n\n\t\t\t\t// Create the \"rows\" that will become the command-line prompts. -- cwells\n\t\t\t\tlet promptLines = '';\n\t\t\t\tconst rowCount = commandLine.numberOfLines || 0;\n\t\t\t\tconst promptText = getAttribute('data-prompt', '');\n\t\t\t\tlet promptLine;\n\t\t\t\tif (promptText !== '') {\n\t\t\t\t\tpromptLine = '<span data-prompt=\"' + promptText + '\"></span>';\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tconst user = getAttribute('data-user', 'user');\n\t\t\t\t\tconst host = getAttribute('data-host', 'localhost');\n\t\t\t\t\tpromptLine = '<span data-user=\"' + user + '\" data-host=\"' + host + '\"></span>';\n\t\t\t\t}\n\n\t\t\t\tconst continuationLineIndicies = commandLine.continuationLineIndicies || new Set();\n\t\t\t\tconst continuationPromptText = getAttribute('data-continuation-prompt', '>');\n\t\t\t\tconst continuationPromptLine =\n\t\t\t\t\t'<span data-continuation-prompt=\"' + continuationPromptText + '\"></span>';\n\n\t\t\t\t// Assemble all the appropriate prompt/continuation lines\n\t\t\t\tfor (let j = 0; j < rowCount; j++) {\n\t\t\t\t\tif (continuationLineIndicies.has(j)) {\n\t\t\t\t\t\tpromptLines += continuationPromptLine;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tpromptLines += promptLine;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Create the wrapper element. -- cwells\n\t\t\t\tconst prompt = document.createElement('span');\n\t\t\t\tprompt.className = PROMPT_CLASS;\n\t\t\t\tprompt.innerHTML = promptLines;\n\n\t\t\t\t// Remove the prompt from the output lines. -- cwells\n\t\t\t\tconst outputLines = commandLine.outputLines || [];\n\t\t\t\tfor (let i = 0, l = outputLines.length; i < l; i++) {\n\t\t\t\t\tif (outputLines.hasOwnProperty(i)) {\n\t\t\t\t\t\tconst node = prompt.children[i];\n\t\t\t\t\t\tnode.removeAttribute('data-user');\n\t\t\t\t\t\tnode.removeAttribute('data-host');\n\t\t\t\t\t\tnode.removeAttribute('data-prompt');\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tenv.element.insertBefore(prompt, env.element.firstChild);\n\t\t\t\tcommandLine.complete = true;\n\t\t\t},\n\t\t});\n\t},\n};\n\nexport default Self;\n\nprism.pluginRegistry.add(Self);\n\n/**\n * @typedef {object} CommandLineInfo\n * @property {boolean} [complete]\n * @property {number} [numberOfLines]\n * @property {string[]} [outputLines]\n * @property {Set<number>} [continuationLineIndicies]\n */\n"],"names":["CLASS_PATTERN","PROMPT_CLASS","Self","id","effect","Prism","hooks","add","env","commandLine","complete","code","pre","getParentPre","element","test","className","existingPrompt","querySelector","remove","codeLines","split","numberOfLines","length","outputLines","outputSections","getAttribute","outputFilter","forEach","section","range","outputStart","parseInt","outputEnd","isNaN","j","i","startsWith","slice","continuationLineIndicies","Set","lineContinuationStr","continuationFilter","line","endsWith","join","highlightedCode","l","hasOwnProperty","htmlEncode","replace","key","defaultValue","promptLines","rowCount","promptText","promptLine","continuationPromptLine","has","prompt","document","createElement","innerHTML","node","children","removeAttribute","insertBefore","firstChild","prism","pluginRegistry"],"mappings":"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"}