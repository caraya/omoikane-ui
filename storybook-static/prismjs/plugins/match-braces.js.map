{"version":3,"file":"match-braces.js","sources":["../../src/plugins/match-braces/match-braces.js"],"sourcesContent":["import prism from '../../global.js';\nimport { getParentPre, isActive } from '../../shared/dom-util.js';\n\n/** @type {import('../../types.d.ts').PluginProto<'match-braces'>} */\nconst Self = {\n\tid: 'match-braces',\n\teffect (Prism) {\n\t\t/**\n\t\t * @param {string} name\n\t\t */\n\t\tfunction mapClassName (name) {\n\t\t\t/** @type {import('../custom-class/custom-class.js').CustomClass} */\n\t\t\tconst customClass = Prism.pluginRegistry.peek('custom-class')?.plugin;\n\t\t\tif (customClass) {\n\t\t\t\treturn customClass.apply(name);\n\t\t\t}\n\t\t\telse {\n\t\t\t\treturn name;\n\t\t\t}\n\t\t}\n\n\t\tconst PARTNER = {\n\t\t\t'(': ')',\n\t\t\t'[': ']',\n\t\t\t'{': '}',\n\t\t};\n\n\t\t// The names for brace types.\n\t\t// These names have two purposes: 1) they can be used for styling and 2) they are used to pair braces. Only braces\n\t\t// of the same type are paired.\n\t\tconst NAMES = {\n\t\t\t'(': 'brace-round',\n\t\t\t'[': 'brace-square',\n\t\t\t'{': 'brace-curly',\n\t\t};\n\n\t\t// A map for brace aliases.\n\t\t// This is useful for when some braces have a prefix/suffix as part of the punctuation token.\n\t\tconst BRACE_ALIAS_MAP = {\n\t\t\t'${': '{', // JS template punctuation (e.g. `foo ${bar + 1}`)\n\t\t};\n\n\t\tconst LEVEL_WARP = 12;\n\n\t\tlet pairIdCounter = 0;\n\n\t\tconst BRACE_ID_PATTERN = /^(pair-\\d+-)(close|open)$/;\n\n\t\t/**\n\t\t * Returns the brace partner given one brace of a brace pair.\n\t\t *\n\t\t * @param {Element} brace\n\t\t */\n\t\tfunction getPartnerBrace (brace) {\n\t\t\tconst match = BRACE_ID_PATTERN.exec(brace.id);\n\t\t\tif (!match) {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t\treturn document.querySelector(\n\t\t\t\t'#' + match[1] + (match[2] === 'open' ? 'close' : 'open')\n\t\t\t);\n\t\t}\n\n\t\t/**\n\t\t * @this {Element}\n\t\t */\n\t\tfunction hoverBrace () {\n\t\t\tif (!isActive(this, 'brace-hover', true)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst partner = getPartnerBrace(this);\n\t\t\tif (!partner) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t[this, partner].forEach(e => {\n\t\t\t\te.classList.add(mapClassName('brace-hover'));\n\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * @this {Element}\n\t\t */\n\t\tfunction leaveBrace () {\n\t\t\tconst partner = getPartnerBrace(this);\n\t\t\tif (!partner) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t[this, partner].forEach(e => {\n\t\t\t\te.classList.remove(mapClassName('brace-hover'));\n\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * @this {Element}\n\t\t */\n\t\tfunction clickBrace () {\n\t\t\tif (!isActive(this, 'brace-select', true)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst partner = getPartnerBrace(this);\n\t\t\tif (!partner) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t[this, partner].forEach(e => {\n\t\t\t\te.classList.add(mapClassName('brace-selected'));\n\t\t\t});\n\t\t}\n\n\t\t/** @type {WeakSet<Element>} */\n\t\tconst withEventListener = new WeakSet();\n\n\t\treturn Prism.hooks.add('complete', env => {\n\t\t\tconst code = env.element;\n\n\t\t\tconst pre = getParentPre(code);\n\t\t\tif (!pre) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// find the braces to match\n\t\t\tconst toMatch = [];\n\t\t\tif (isActive(code, 'match-braces')) {\n\t\t\t\ttoMatch.push('(', '[', '{');\n\t\t\t}\n\n\t\t\tif (toMatch.length === 0) {\n\t\t\t\t// nothing to match\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (!withEventListener.has(pre)) {\n\t\t\t\t// code blocks might be highlighted more than once\n\t\t\t\twithEventListener.add(pre);\n\t\t\t\tpre.addEventListener('mousedown', () => {\n\t\t\t\t\t// the code element might have been replaced\n\t\t\t\t\tconst code = pre.querySelector('code');\n\t\t\t\t\tconst className = mapClassName('brace-selected');\n\t\t\t\t\tcode?.querySelectorAll('.' + className).forEach(e => {\n\t\t\t\t\t\te.classList.remove(className);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst punctuation = [\n\t\t\t\t...code.querySelectorAll(\n\t\t\t\t\t'span.' + mapClassName('token') + '.' + mapClassName('punctuation')\n\t\t\t\t),\n\t\t\t];\n\n\t\t\t/** @type {{ index: number, open: boolean, element: Element }[]} */\n\t\t\tconst allBraces = [];\n\n\t\t\ttoMatch.forEach(open => {\n\t\t\t\tconst close = PARTNER[open];\n\t\t\t\tconst name = mapClassName(NAMES[open]);\n\n\t\t\t\tconst pairs = [];\n\t\t\t\t/** @type {number[]} */\n\t\t\t\tconst openStack = [];\n\n\t\t\t\tfor (let i = 0; i < punctuation.length; i++) {\n\t\t\t\t\tconst element = punctuation[i];\n\t\t\t\t\tif (element.childElementCount === 0) {\n\t\t\t\t\t\tlet text = element.textContent || '';\n\t\t\t\t\t\ttext = BRACE_ALIAS_MAP[text] || text;\n\t\t\t\t\t\tif (text === open) {\n\t\t\t\t\t\t\tallBraces.push({ index: i, open: true, element });\n\t\t\t\t\t\t\telement.classList.add(name);\n\t\t\t\t\t\t\telement.classList.add(mapClassName('brace-open'));\n\t\t\t\t\t\t\topenStack.push(i);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (text === close) {\n\t\t\t\t\t\t\tallBraces.push({ index: i, open: false, element });\n\t\t\t\t\t\t\telement.classList.add(name);\n\t\t\t\t\t\t\telement.classList.add(mapClassName('brace-close'));\n\t\t\t\t\t\t\tconst popped = openStack.pop();\n\t\t\t\t\t\t\tif (popped !== undefined) {\n\t\t\t\t\t\t\t\tpairs.push([i, popped]);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tpairs.forEach(pair => {\n\t\t\t\t\tconst pairId = `pair-${pairIdCounter++}-`;\n\n\t\t\t\t\tconst opening = punctuation[pair[0]];\n\t\t\t\t\tconst closing = punctuation[pair[1]];\n\n\t\t\t\t\topening.id = pairId + 'open';\n\t\t\t\t\tclosing.id = pairId + 'close';\n\n\t\t\t\t\t[opening, closing].forEach(e => {\n\t\t\t\t\t\te.addEventListener('mouseenter', hoverBrace);\n\t\t\t\t\t\te.addEventListener('mouseleave', leaveBrace);\n\t\t\t\t\t\te.addEventListener('click', clickBrace);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tlet level = 0;\n\t\t\tallBraces.sort((a, b) => a.index - b.index);\n\t\t\tallBraces.forEach(brace => {\n\t\t\t\tif (brace.open) {\n\t\t\t\t\tbrace.element.classList.add(\n\t\t\t\t\t\tmapClassName(`brace-level-${(level % LEVEL_WARP) + 1}`)\n\t\t\t\t\t);\n\t\t\t\t\tlevel++;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tlevel = Math.max(0, level - 1);\n\t\t\t\t\tbrace.element.classList.add(\n\t\t\t\t\t\tmapClassName(`brace-level-${(level % LEVEL_WARP) + 1}`)\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t},\n};\n\nexport default Self;\n\nprism.pluginRegistry.add(Self);\n"],"names":["Self","id","effect","Prism","mapClassName","name","customClass","pluginRegistry","peek","plugin","apply","PARTNER","NAMES","BRACE_ALIAS_MAP","pairIdCounter","BRACE_ID_PATTERN","getPartnerBrace","brace","match","exec","document","querySelector","hoverBrace","isActive","this","partner","forEach","e","classList","add","leaveBrace","remove","clickBrace","withEventListener","WeakSet","hooks","env","code","element","pre","getParentPre","toMatch","push","length","has","addEventListener","className","querySelectorAll","punctuation","allBraces","open","close","pairs","openStack","i","childElementCount","text","textContent","index","popped","pop","undefined","pair","pairId","opening","closing","level","sort","a","b","Math","max","prism"],"mappings":"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"}