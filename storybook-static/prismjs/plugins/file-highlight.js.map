{"version":3,"file":"file-highlight.js","sources":["../../src/plugins/file-highlight/file-highlight.js"],"sourcesContent":["import prism from '../../global.js';\nimport { setLanguage } from '../../shared/dom-util.js';\n\n/**\n *\n * @param {number} status\n * @param {string} message\n * @returns {string}\n */\nconst FAILURE_MESSAGE = (status, message) => {\n\treturn `✖ Error ${status} while fetching file: ${message}`;\n};\nconst LOADING_MESSAGE = 'Loading…';\nconst FAILURE_EMPTY_MESSAGE = '✖ Error: File does not exist or is empty';\n\n/**\n * Loads the given file.\n *\n * @param {string} src The URL or path of the source file to load.\n * @param {(result: string) => void} success\n * @param {(reason: string) => void} error\n */\nfunction loadFile (src, success, error) {\n\tconst xhr = new XMLHttpRequest();\n\txhr.open('GET', src, true);\n\txhr.onreadystatechange = function () {\n\t\tif (xhr.readyState === 4) {\n\t\t\tif (xhr.status < 400 && xhr.responseText) {\n\t\t\t\tsuccess(xhr.responseText);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif (xhr.status >= 400) {\n\t\t\t\t\terror(FAILURE_MESSAGE(xhr.status, xhr.statusText));\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\terror(FAILURE_EMPTY_MESSAGE);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t};\n\txhr.send(null);\n}\n\nconst EXTENSIONS = {\n\t'js': 'javascript',\n\t'py': 'python',\n\t'rb': 'ruby',\n\t'ps1': 'powershell',\n\t'psm1': 'powershell',\n\t'sh': 'bash',\n\t'bat': 'batch',\n\t'h': 'c',\n\t'tex': 'latex',\n};\n\nconst STATUS_ATTR = 'data-src-status';\nconst STATUS_LOADING = 'loading';\nconst STATUS_LOADED = 'loaded';\nconst STATUS_FAILED = 'failed';\n\nconst SELECTOR =\n\t'pre[data-src]:not([' +\n\tSTATUS_ATTR +\n\t'=\"' +\n\tSTATUS_LOADED +\n\t'\"])' +\n\t':not([' +\n\tSTATUS_ATTR +\n\t'=\"' +\n\tSTATUS_LOADING +\n\t'\"])';\n\nexport class FileHighlight {\n\t/**\n\t * @param {Prism} Prism\n\t */\n\tPrism;\n\n\t/**\n\t * @package\n\t * @param {Prism} Prism\n\t */\n\tconstructor (Prism) {\n\t\tthis.Prism = Prism;\n\t}\n\n\t/**\n\t * Executes the File Highlight plugin for all matching `pre` elements under the given container.\n\t *\n\t * Note: Elements which are already loaded or currently loading will not be touched by this method.\n\t *\n\t * @param {ParentNode} [container=document] Defaults to `document`.\n\t */\n\thighlight (container = document) {\n\t\tconst elements = container.querySelectorAll(SELECTOR);\n\n\t\tfor (const element of elements) {\n\t\t\tthis.Prism.highlightElement(element);\n\t\t}\n\t}\n}\n\n/** @type {import('../../types.d.ts').PluginProto<'file-highlight'>} */\nconst Self = {\n\tid: 'file-highlight',\n\tplugin (Prism) {\n\t\treturn new FileHighlight(Prism);\n\t},\n\teffect (Prism) {\n\t\t/**\n\t\t * Parses the given range.\n\t\t *\n\t\t * This returns a range with inclusive ends.\n\t\t *\n\t\t * @param {string | null | undefined} range\n\t\t * @returns {Array | undefined}\n\t\t */\n\t\tfunction parseRange (range) {\n\t\t\tconst m = /^\\s*(\\d+)\\s*(?:(,)\\s*(?:(\\d+)\\s*)?)?$/.exec(range || '');\n\t\t\tif (m) {\n\t\t\t\tconst start = Number(m[1]);\n\t\t\t\tconst comma = m[2];\n\t\t\t\tconst end = m[3];\n\n\t\t\t\tif (!comma) {\n\t\t\t\t\treturn [start, start];\n\t\t\t\t}\n\t\t\t\tif (!end) {\n\t\t\t\t\treturn [start, undefined];\n\t\t\t\t}\n\t\t\t\treturn [start, Number(end)];\n\t\t\t}\n\t\t\treturn undefined;\n\t\t}\n\n\t\treturn Prism.hooks.add({\n\t\t\t'before-highlightall': env => {\n\t\t\t\tenv.selector += ', ' + SELECTOR;\n\t\t\t},\n\t\t\t'before-sanity-check': env => {\n\t\t\t\t/** @type {HTMLPreElement} */\n\t\t\t\tconst pre = env.element;\n\n\t\t\t\tif (!pre.matches(SELECTOR)) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst src = pre.getAttribute('data-src');\n\t\t\t\tif (!src) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tenv.code = ''; // fast-path the whole thing and go to complete\n\n\t\t\t\tpre.setAttribute(STATUS_ATTR, STATUS_LOADING); // mark as loading\n\n\t\t\t\t// add code element with loading message\n\t\t\t\tconst code = pre.appendChild(document.createElement('CODE'));\n\t\t\t\tcode.textContent = LOADING_MESSAGE;\n\n\t\t\t\tlet language = env.language;\n\t\t\t\tif (language === 'none') {\n\t\t\t\t\t// the language might be 'none' because there is no language set;\n\t\t\t\t\t// in this case, we want to use the extension as the language\n\t\t\t\t\tconst extension = /\\.(\\w+)$/.exec(src)?.[1] || 'none';\n\t\t\t\t\tlanguage = EXTENSIONS[extension] || extension;\n\t\t\t\t}\n\n\t\t\t\t// set language classes\n\t\t\t\tsetLanguage(code, language);\n\t\t\t\tsetLanguage(pre, language);\n\n\t\t\t\t// preload the language\n\t\t\t\t/** @type {import('../autoloader/autoloader.js').Autoloader} */\n\t\t\t\tconst autoloader = Prism.pluginRegistry.peek('autoloader')?.plugin;\n\t\t\t\tif (autoloader) {\n\t\t\t\t\tautoloader.preloadLanguages(language);\n\t\t\t\t}\n\n\t\t\t\t// load file\n\t\t\t\tloadFile(\n\t\t\t\t\tsrc,\n\t\t\t\t\ttext => {\n\t\t\t\t\t\t// mark as loaded\n\t\t\t\t\t\tpre.setAttribute(STATUS_ATTR, STATUS_LOADED);\n\n\t\t\t\t\t\t// handle data-range\n\t\t\t\t\t\tconst range = parseRange(pre.getAttribute('data-range'));\n\t\t\t\t\t\tif (range) {\n\t\t\t\t\t\t\tconst lines = text.split(/\\r\\n?|\\n/);\n\n\t\t\t\t\t\t\t// the range is one-based and inclusive on both ends\n\t\t\t\t\t\t\tlet start = range[0];\n\t\t\t\t\t\t\tlet end = range[1] == null ? lines.length : range[1];\n\n\t\t\t\t\t\t\tif (start < 0) {\n\t\t\t\t\t\t\t\tstart += lines.length;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tstart = Math.max(0, Math.min(start - 1, lines.length));\n\t\t\t\t\t\t\tif (end < 0) {\n\t\t\t\t\t\t\t\tend += lines.length;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tend = Math.max(0, Math.min(end, lines.length));\n\n\t\t\t\t\t\t\ttext = lines.slice(start, end).join('\\n');\n\n\t\t\t\t\t\t\t// add data-start for line numbers\n\t\t\t\t\t\t\tif (!pre.hasAttribute('data-start')) {\n\t\t\t\t\t\t\t\tpre.setAttribute('data-start', String(start + 1));\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// highlight code\n\t\t\t\t\t\tcode.textContent = text;\n\t\t\t\t\t\tPrism.highlightElement(code);\n\t\t\t\t\t},\n\t\t\t\t\terror => {\n\t\t\t\t\t\t// mark as failed\n\t\t\t\t\t\tpre.setAttribute(STATUS_ATTR, STATUS_FAILED);\n\n\t\t\t\t\t\tcode.textContent = error;\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t},\n\t\t});\n\t},\n};\n\nexport default Self;\n\nprism.pluginRegistry.add(Self);\n\n/**\n * @typedef {import('../../core.js').Prism} Prism\n */\n"],"names":["EXTENSIONS","js","py","rb","ps1","psm1","sh","bat","h","tex","STATUS_ATTR","STATUS_LOADING","STATUS_LOADED","SELECTOR","FileHighlight","Prism","constructor","this","highlight","container","document","elements","querySelectorAll","element","highlightElement","Self","id","plugin","effect","hooks","add","env","selector","pre","matches","src","getAttribute","code","setAttribute","appendChild","createElement","textContent","language","extension","exec","setLanguage","autoloader","pluginRegistry","peek","preloadLanguages","success","error","xhr","XMLHttpRequest","open","onreadystatechange","readyState","status","responseText","text","range","m","start","comma","end","undefined","parseRange","lines","split","length","Math","max","min","slice","join","hasAttribute","String","statusText","send","loadFile","prism"],"mappings":"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"}