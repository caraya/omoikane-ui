{"version":3,"file":"copy-to-clipboard.js","sources":["../../src/plugins/copy-to-clipboard/copy-to-clipboard.js"],"sourcesContent":["import prism from '../../global.js';\nimport toolbar from '../toolbar/toolbar.js';\n\n/**\n * When the given elements is clicked by the user, the given text will be copied to clipboard.\n *\n * @param {Element} element\n * @param {CopyInfo} copyInfo\n */\nfunction registerClipboard (element, copyInfo) {\n\telement.addEventListener('click', () => {\n\t\tcopyTextToClipboard(copyInfo);\n\t});\n}\n\n// https://stackoverflow.com/a/30810322/7595472\n\n/**\n * @param {CopyInfo} copyInfo\n */\nfunction fallbackCopyTextToClipboard (copyInfo) {\n\tconst textArea = document.createElement('textarea');\n\ttextArea.value = copyInfo.getText();\n\n\t// Avoid scrolling to bottom\n\ttextArea.style.top = '0';\n\ttextArea.style.left = '0';\n\ttextArea.style.position = 'fixed';\n\n\tdocument.body.appendChild(textArea);\n\ttextArea.focus();\n\ttextArea.select();\n\n\ttry {\n\t\tconst successful = document.execCommand('copy');\n\t\tsetTimeout(() => {\n\t\t\tif (successful) {\n\t\t\t\tcopyInfo.success();\n\t\t\t}\n\t\t\telse {\n\t\t\t\tcopyInfo.error(undefined);\n\t\t\t}\n\t\t}, 1);\n\t}\n\tcatch (err) {\n\t\tsetTimeout(() => {\n\t\t\tcopyInfo.error(err);\n\t\t}, 1);\n\t}\n\n\tdocument.body.removeChild(textArea);\n}\n\n/**\n * @param {CopyInfo} copyInfo\n */\nfunction copyTextToClipboard (copyInfo) {\n\tif (navigator.clipboard) {\n\t\tnavigator.clipboard.writeText(copyInfo.getText()).then(copyInfo.success, () => {\n\t\t\t// try the fallback in case `writeText` didn't work\n\t\t\tfallbackCopyTextToClipboard(copyInfo);\n\t\t});\n\t}\n\telse {\n\t\tfallbackCopyTextToClipboard(copyInfo);\n\t}\n}\n\n/**\n * Selects the text content of the given element.\n *\n * @param {Element} element\n */\nfunction selectElementText (element) {\n\t// https://stackoverflow.com/a/20079910/7595472\n\twindow.getSelection()?.selectAllChildren(element);\n}\n\n/**\n * @param {Element} element\n * @param {string} attribute\n * @returns {string | null}\n */\nfunction getInheritedAttribute (element, attribute) {\n\t/** @type {Element | null} */\n\tlet e = element;\n\tfor (; e; e = e.parentElement) {\n\t\tconst value = e.getAttribute(attribute);\n\t\tif (value !== null) {\n\t\t\treturn value;\n\t\t}\n\t}\n\treturn null;\n}\n\n/**\n * Traverses up the DOM tree to find data attributes that override the default plugin settings.\n *\n * @param {Element} startElement An element to start from.\n * @returns {Settings} The plugin settings.\n */\nfunction getSettings (startElement) {\n\t/** @type {Settings} */\n\tconst settings = {\n\t\t'copy': 'Copy',\n\t\t'copy-error': 'Press Ctrl+C to copy',\n\t\t'copy-success': 'Copied!',\n\t\t'copy-timeout': 5000,\n\t};\n\n\tfor (const k in settings) {\n\t\tconst key = k;\n\t\tconst value = getInheritedAttribute(startElement, 'data-prismjs-' + key);\n\t\tif (value) {\n\t\t\tif (key === 'copy-timeout') {\n\t\t\t\tconst n = Number(value);\n\t\t\t\tif (!Number.isNaN(n)) {\n\t\t\t\t\tsettings[key] = n;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tsettings[key] = value;\n\t\t\t}\n\t\t}\n\t}\n\treturn settings;\n}\n\n/** @type {import('../../types.d.ts').PluginProto<'copy-to-clipboard'>} */\nconst Self = {\n\tid: 'copy-to-clipboard',\n\trequire: toolbar,\n\teffect (Prism) {\n\t\t/** @type {import('../toolbar/toolbar.js').Toolbar} */\n\t\tconst toolbar = Prism.pluginRegistry.peek('toolbar')?.plugin;\n\n\t\treturn toolbar.registerButton('copy-to-clipboard', env => {\n\t\t\tconst element = env.element;\n\n\t\t\tconst settings = getSettings(element);\n\n\t\t\tconst linkCopy = document.createElement('button');\n\t\t\tlinkCopy.className = 'copy-to-clipboard-button';\n\t\t\tlinkCopy.setAttribute('type', 'button');\n\t\t\tconst linkSpan = document.createElement('span');\n\t\t\tlinkCopy.appendChild(linkSpan);\n\n\t\t\tsetState('copy');\n\n\t\t\tregisterClipboard(linkCopy, {\n\t\t\t\tgetText () {\n\t\t\t\t\treturn element.textContent || '';\n\t\t\t\t},\n\t\t\t\tsuccess () {\n\t\t\t\t\tsetState('copy-success');\n\n\t\t\t\t\tresetText();\n\t\t\t\t},\n\t\t\t\terror () {\n\t\t\t\t\tsetState('copy-error');\n\n\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\tselectElementText(element);\n\t\t\t\t\t}, 1);\n\n\t\t\t\t\tresetText();\n\t\t\t\t},\n\t\t\t});\n\n\t\t\treturn linkCopy;\n\n\t\t\tfunction resetText () {\n\t\t\t\tsetTimeout(() => setState('copy'), settings['copy-timeout']);\n\t\t\t}\n\n\t\t\t/**\n\t\t\t * @param {'copy' | 'copy-error' | 'copy-success'} state\n\t\t\t */\n\t\t\tfunction setState (state) {\n\t\t\t\tlinkSpan.textContent = settings[state];\n\t\t\t\tlinkCopy.setAttribute('data-copy-state', state);\n\t\t\t}\n\t\t});\n\t},\n};\n\nexport default Self;\n\nprism.pluginRegistry.add(Self);\n\n/**\n * @typedef {object} CopyInfo\n * @property {function(): string} getText\n * @property {function(): void} success\n * @property {(reason: any) => void} error\n */\n\n/**\n * @typedef {object} Settings\n * @property {string} copy\n * @property {string} copy-error\n * @property {string} copy-success\n * @property {number} copy-timeout\n */\n"],"names":["fallbackCopyTextToClipboard","copyInfo","textArea","document","createElement","value","getText","style","top","left","position","body","appendChild","focus","select","successful","execCommand","setTimeout","success","error","undefined","err","removeChild","getInheritedAttribute","element","attribute","e","parentElement","getAttribute","Self","id","require","toolbar","effect","Prism","pluginRegistry","peek","plugin","registerButton","env","settings","startElement","copy","k","key","n","Number","isNaN","getSettings","linkCopy","className","setAttribute","linkSpan","setState","addEventListener","navigator","clipboard","writeText","then","copyTextToClipboard","registerClipboard","textContent","resetText","window","getSelection","selectAllChildren","selectElementText","state","prism","add"],"mappings":"6LAoBA,SAASA,EAA6BC,GACrC,MAAMC,EAAWC,SAASC,cAAc,YACxCF,EAASG,MAAQJ,EAASK,UAG1BJ,EAASK,MAAMC,IAAM,IACrBN,EAASK,MAAME,KAAO,IACtBP,EAASK,MAAMG,SAAW,QAE1BP,SAASQ,KAAKC,YAAYV,GAC1BA,EAASW,QACTX,EAASY,SAET,IACC,MAAMC,EAAaZ,SAASa,YAAY,QACxCC,YAAW,KACNF,EACHd,EAASiB,UAGTjB,EAASkB,WAAMC,EACnB,GACK,EACL,CACC,MAAOC,GACNJ,YAAW,KACVhB,EAASkB,MAAME,EAAI,GACjB,EACL,CAEClB,SAASQ,KAAKW,YAAYpB,EAC3B,CAgCA,SAASqB,EAAuBC,EAASC,GAExC,IAAIC,EAAIF,EACR,KAAOE,EAAGA,EAAIA,EAAEC,cAAe,CAC9B,MAAMtB,EAAQqB,EAAEE,aAAaH,GAC7B,GAAc,OAAVpB,EACH,OAAOA,CAEV,CACC,OAAO,IACR,CAoCK,MAACwB,EAAO,CACZC,GAAI,oBACJC,QAASC,EACT,MAAAC,CAAQC,GAEP,MAAMF,EAAUE,EAAMC,eAAeC,KAAK,YAAYC,OAEtD,OAAOL,EAAQM,eAAe,qBAAqBC,IAClD,MAAMf,EAAUe,EAAIf,QAEdgB,EAtCT,CAAsBC,IAErB,MAAMD,EAAW,CAChBE,KAAQ,OACR,aAAc,uBACd,eAAgB,UAChB,eAAgB,KAGjB,IAAK,MAAMC,KAAKH,EAAU,CACzB,MAAMI,EAAMD,EACNtC,EAAQkB,EAAsBkB,EAAc,gBAAkBG,GACpE,GAAIvC,EACH,GAAY,iBAARuC,EAAwB,CAC3B,MAAMC,GAAWxC,EACZyC,OAAOC,MAAMF,KACjBL,EAASI,GAAOC,EAErB,MAEIL,EAASI,GAAOvC,CAGpB,CACC,OAAOmC,CACR,EAaoBQ,CAAYxB,GAEvByB,EAAW9C,SAASC,cAAc,UACxC6C,EAASC,UAAY,2BACrBD,EAASE,aAAa,OAAQ,UAC9B,MAAMC,EAAWjD,SAASC,cAAc,QAyBxC,OAxBA6C,EAASrC,YAAYwC,GAErBC,EAAS,QA1IZ,EAA4B7B,EAASvB,KACpCuB,EAAQ8B,iBAAiB,SAAS,KA8CnC,CAA8BrD,IACzBsD,UAAUC,UACbD,UAAUC,UAAUC,UAAUxD,EAASK,WAAWoD,KAAKzD,EAASiB,SAAS,KAExElB,EAA4BC,EAAS,IAItCD,EAA4BC,EAE9B,EAvDE0D,CAAoB1D,EAAS,GAE/B,EAwIG2D,CAAkBX,EAAU,CAC3B3C,QAAQ,IACAkB,EAAQqC,aAAe,GAE/B,OAAA3C,GACCmC,EAAS,gBAETS,GACA,EACD,KAAA3C,GACCkC,EAAS,cAETpC,YAAW,KAxFhB,CAA4BO,IAE3BuC,OAAOC,gBAAgBC,kBAAkBzC,EAC1C,EAsFM0C,CAAkB1C,EAAQ,GACxB,GAEHsC,GACA,IAGKb,EAEP,SAASa,IACR7C,YAAW,IAAMoC,EAAS,SAASb,EAAS,gBAChD,CAKG,SAASa,EAAUc,GAClBf,EAASS,YAAcrB,EAAS2B,GAChClB,EAASE,aAAa,kBAAmBgB,EAC7C,IAEE,GAKFC,EAAMjC,eAAekC,IAAIxC"}