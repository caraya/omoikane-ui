{"version":3,"file":"toolbar.js","sources":["../../src/plugins/toolbar/toolbar.js"],"sourcesContent":["import prism from '../../global.js';\nimport { getParentPre } from '../../shared/dom-util.js';\nimport { noop } from '../../shared/util.js';\n\n/**\n * Returns the callback order of the given element.\n *\n * @param {Element} element\n */\nfunction getOrder (element) {\n\t/** @type {Element | null} */\n\tlet e = element;\n\tfor (; e; e = e.parentElement) {\n\t\tlet order = e.getAttribute('data-toolbar-order');\n\t\tif (order != null) {\n\t\t\torder = order.trim();\n\t\t\tif (order.length) {\n\t\t\t\treturn order.split(/\\s*,\\s*/);\n\t\t\t}\n\t\t\telse {\n\t\t\t\treturn [];\n\t\t\t}\n\t\t}\n\t}\n}\n\nexport class Toolbar {\n\t/**\n\t * @type {ButtonFactory[]}\n\t */\n\tcallbacks = [];\n\n\t/**\n\t * @type {Map<string, ButtonFactory>}\n\t */\n\tmap = new Map();\n\n\t/**\n\t * Register a button callback with the toolbar.\n\t *\n\t * The returned function will remove the added callback again when called.\n\t *\n\t * @param {string} key\n\t * @param {ButtonOptions | ButtonFactory} opts\n\t * @returns {function():void}\n\t */\n\tregisterButton (key, opts) {\n\t\t/** @type {ButtonFactory} */\n\t\tlet callback;\n\n\t\tif (typeof opts === 'function') {\n\t\t\tcallback = opts;\n\t\t}\n\t\telse {\n\t\t\tcallback = function (env) {\n\t\t\t\tconst { text, url, onClick, className } = opts;\n\n\t\t\t\tlet element;\n\t\t\t\tif (typeof onClick === 'function') {\n\t\t\t\t\telement = document.createElement('button');\n\t\t\t\t\telement.type = 'button';\n\t\t\t\t\telement.addEventListener('click', function () {\n\t\t\t\t\t\tonClick.call(this, env);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\telse if (typeof url === 'string') {\n\t\t\t\t\telement = document.createElement('a');\n\t\t\t\t\telement.href = url;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\telement = document.createElement('span');\n\t\t\t\t}\n\n\t\t\t\tif (className) {\n\t\t\t\t\telement.classList.add(className);\n\t\t\t\t}\n\n\t\t\t\telement.textContent = text;\n\n\t\t\t\treturn element;\n\t\t\t};\n\t\t}\n\n\t\tif (this.map.has(key)) {\n\t\t\tconsole.warn('There is a button with the key \"' + key + '\" registered already.');\n\t\t\treturn noop;\n\t\t}\n\n\t\tthis.map.set(key, callback);\n\t\tthis.callbacks.push(callback);\n\n\t\treturn () => {\n\t\t\tthis.map.delete(key);\n\t\t\tconst index = this.callbacks.indexOf(callback);\n\t\t\tif (index !== -1) {\n\t\t\t\tthis.callbacks.splice(index, 1);\n\t\t\t}\n\t\t};\n\t}\n\n\t/**\n\t * @type {HookCallback}\n\t */\n\thook = env => {\n\t\t// Check if inline or actual code block (credit to line-numbers plugin)\n\t\tconst pre = getParentPre(env.element);\n\t\tif (!pre) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst container = pre.parentElement;\n\t\tif (!container) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Autoloader rehighlights, so only do this once.\n\t\tif (container.classList.contains('code-toolbar')) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Create wrapper for <pre> to prevent scrolling toolbar with content\n\t\tconst wrapper = document.createElement('div');\n\t\twrapper.classList.add('code-toolbar');\n\t\tcontainer.insertBefore(wrapper, pre);\n\t\twrapper.appendChild(pre);\n\n\t\t// Setup the toolbar\n\t\tconst toolbar = document.createElement('div');\n\t\ttoolbar.classList.add('toolbar');\n\n\t\t// order callbacks\n\t\tlet elementCallbacks = this.callbacks;\n\t\tconst order = getOrder(env.element);\n\t\tif (order) {\n\t\t\telementCallbacks = /** @type {ButtonFactory[]} */ (\n\t\t\t\torder.map(key => this.map.get(key) || noop)\n\t\t\t);\n\t\t}\n\n\t\telementCallbacks.forEach(callback => {\n\t\t\tconst element = callback(env);\n\n\t\t\tif (!element) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst item = document.createElement('div');\n\t\t\titem.classList.add('toolbar-item');\n\n\t\t\titem.appendChild(element);\n\t\t\ttoolbar.appendChild(item);\n\t\t});\n\n\t\t// Add our toolbar to the currently created wrapper of <pre> tag\n\t\twrapper.appendChild(toolbar);\n\t};\n}\n\n/** @type {ButtonFactory} */\nconst label = env => {\n\tconst pre = getParentPre(env.element);\n\tif (!pre) {\n\t\treturn;\n\t}\n\n\tif (!pre.hasAttribute('data-label')) {\n\t\treturn;\n\t}\n\n\tlet element;\n\tlet template;\n\tconst text = pre.getAttribute('data-label');\n\ttry {\n\t\t// Any normal text will blow up this selector.\n\t\tif (text) {\n\t\t\ttemplate = document.querySelector('template#' + text);\n\t\t}\n\t}\n\tcatch {\n\t\t/* noop */\n\t}\n\n\tif (template) {\n\t\telement = /** @type {HTMLTemplateElement} */ (template).content;\n\t}\n\telse {\n\t\tconst url = pre.getAttribute('data-url');\n\t\tif (url) {\n\t\t\telement = document.createElement('a');\n\t\t\telement.href = url;\n\t\t}\n\t\telse {\n\t\t\telement = document.createElement('span');\n\t\t}\n\n\t\telement.textContent = text;\n\t}\n\n\treturn element;\n};\n\n/** @type {import('../../types.d.ts').PluginProto<'toolbar'>} */\nconst Self = {\n\tid: 'toolbar',\n\tplugin () {\n\t\tconst toolbar = new Toolbar();\n\t\ttoolbar.registerButton('label', label);\n\t\treturn toolbar;\n\t},\n\teffect (Prism) {\n\t\t/** @type {Toolbar} */\n\t\tconst toolbar = Prism.pluginRegistry.peek(Self)?.plugin;\n\t\treturn Prism.hooks.add('complete', toolbar.hook);\n\t},\n};\n\nexport default Self;\n\nprism.pluginRegistry.add(Self);\n\n/**\n * @typedef {import('../../types.d.ts').HookEnv} HookEnv\n * @typedef {import('../../types.d.ts').HookCallback} HookCallback\n */\n\n/**\n * @typedef {object} ButtonOptions\n * @property {string} text The text displayed.\n * @property {string} [url] The URL of the link which will be created.\n * @property {(env: HookEnv) => void} [onClick] The event listener for the `click` event of the created button.\n * @property {string} [className] The class attribute to include with the element.\n */\n\n/**\n * @callback ButtonFactory\n * @param {HookEnv} env\n * @returns {Node | undefined}\n */\n"],"names":["Toolbar","callbacks","map","Map","registerButton","key","opts","callback","env","text","url","onClick","className","element","document","createElement","type","addEventListener","call","this","href","classList","add","textContent","has","console","warn","noop","set","push","delete","index","indexOf","splice","hook","pre","getParentPre","container","parentElement","contains","wrapper","insertBefore","appendChild","toolbar","elementCallbacks","order","e","getAttribute","trim","length","split","getOrder","get","forEach","item","label","hasAttribute","template","querySelector","content","Self","id","plugin","effect","Prism","pluginRegistry","peek","hooks","prism"],"mappings":"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"}