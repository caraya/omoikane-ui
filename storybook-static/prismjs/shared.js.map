{"version":3,"file":"shared.js","sources":["../src/shared/languages/templating.js"],"sourcesContent":["import { getTextContent } from '../../core/classes/token.js';\nimport { resolve } from '../../core/tokenize/util.js';\nimport { withoutTokenize } from '../../util/language-util.js';\n\nconst placeholderPattern = /___PH\\d+___/;\n\n/**\n * @param {number} id\n * @returns {string}\n */\nfunction getPlaceholder (id) {\n\treturn `___PH${id}___`;\n}\n\n/**\n * @param {string} code\n * @param {Grammar | undefined} grammar\n * @param {Prism} Prism\n * @returns {{ hostCode: string, tokenStack: TokenStack }}\n */\nfunction buildPlaceholders (code, grammar, Prism) {\n\tif (!grammar) {\n\t\treturn { hostCode: code, tokenStack: [] };\n\t}\n\n\tconst templateTokens = Prism.tokenize(code, grammar);\n\tconst hasPlaceholderLike = placeholderPattern.test(code);\n\n\tlet hostCode = '';\n\n\t/** @type {TokenStack} */\n\tconst tokenStack = [];\n\n\tlet id = 0;\n\tfor (const token of templateTokens) {\n\t\tif (typeof token === 'string') {\n\t\t\thostCode += token;\n\t\t}\n\t\telse if (token.type.startsWith('ignore')) {\n\t\t\thostCode += getTextContent(token.content);\n\t\t}\n\t\telse {\n\t\t\tif (hasPlaceholderLike) {\n\t\t\t\twhile (code.includes(getPlaceholder(id))) {\n\t\t\t\t\tid++;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\ttokenStack.push([id, token]);\n\t\t\thostCode += getPlaceholder(id);\n\t\t\tid++;\n\t\t}\n\t}\n\n\treturn { hostCode, tokenStack };\n}\n\n/**\n * @param {TokenStream} hostTokens\n * @param {TokenStack} tokenStack\n */\nfunction insertIntoHostToken (hostTokens, tokenStack) {\n\tlet j = 0;\n\n\t/**\n\t * @param {TokenStream} tokens\n\t * @returns {TokenStream}\n\t */\n\tconst walkTokens = tokens => {\n\t\tfor (let i = 0; i < tokens.length; i++) {\n\t\t\t// all placeholders are replaced already\n\t\t\tif (j >= tokenStack.length) {\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tconst token = tokens[i];\n\t\t\tif (typeof token === 'string' || typeof token.content === 'string') {\n\t\t\t\tconst [id, t] = tokenStack[j];\n\t\t\t\tconst s = typeof token === 'string' ? token : /** @type {string} */ (token.content);\n\t\t\t\tconst placeholder = getPlaceholder(id);\n\n\t\t\t\tconst index = s.indexOf(placeholder);\n\t\t\t\tif (index > -1) {\n\t\t\t\t\t++j;\n\n\t\t\t\t\tconst before = s.substring(0, index);\n\t\t\t\t\tconst middle = t;\n\t\t\t\t\tconst after = s.substring(index + placeholder.length);\n\n\t\t\t\t\t/** @type {TokenStream} */\n\t\t\t\t\tconst replacement = [];\n\t\t\t\t\tif (before) {\n\t\t\t\t\t\treplacement.push(before);\n\t\t\t\t\t}\n\t\t\t\t\treplacement.push(middle);\n\t\t\t\t\tif (after) {\n\t\t\t\t\t\treplacement.push(...walkTokens([after]));\n\t\t\t\t\t}\n\n\t\t\t\t\tif (typeof token === 'string') {\n\t\t\t\t\t\ttokens.splice(i, 1, ...replacement);\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\ttoken.content = replacement;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\twalkTokens(token.content);\n\t\t\t}\n\t\t}\n\n\t\treturn tokens;\n\t};\n\n\twalkTokens(hostTokens);\n}\n\n/**\n * @param {string} code\n * @param {GrammarRef} hostGrammar\n * @param {GrammarRef} templateGrammar\n * @param {Prism} Prism\n * @returns {TokenStream}\n */\nexport function templating (code, hostGrammar, templateGrammar, Prism) {\n\thostGrammar = resolve.call(Prism, hostGrammar);\n\ttemplateGrammar = resolve.call(Prism, templateGrammar);\n\n\tconst { hostCode, tokenStack } = buildPlaceholders(code, templateGrammar, Prism);\n\n\tconst tokens = hostGrammar ? Prism.tokenize(hostCode, hostGrammar) : [hostCode];\n\tinsertIntoHostToken(tokens, tokenStack);\n\treturn tokens;\n}\n\n/**\n * @param {GrammarRef} hostGrammar\n * @returns {(code: string, grammar: Grammar, Prism: Prism) => TokenStream}\n */\nexport function embeddedIn (hostGrammar) {\n\treturn (code, templateGrammar, Prism) => {\n\t\treturn templating(code, hostGrammar, withoutTokenize(templateGrammar), Prism);\n\t};\n}\n\n/**\n * @import { Prism, Token } from '../../core.js';\n * @import { TokenStream, TokenStack, Grammar, LanguageRegistry} from '../../types.d.ts';\n */\n\n/**\n * @typedef {Grammar | string | undefined | null} GrammarRef\n */\n"],"names":["placeholderPattern","getPlaceholder","id","templating","code","hostGrammar","templateGrammar","Prism","resolve","call","hostCode","tokenStack","grammar","templateTokens","tokenize","hasPlaceholderLike","test","token","type","startsWith","getTextContent","content","includes","push","buildPlaceholders","tokens","hostTokens","j","walkTokens","i","length","t","s","placeholder","index","indexOf","before","substring","middle","after","replacement","splice","insertIntoHostToken","embeddedIn","withoutTokenize"],"mappings":"+UAIA,MAAMA,EAAqB,cAM3B,SAASC,EAAgBC,GACxB,MAAO,QAAQA,MAChB,CAiHO,SAASC,EAAYC,EAAMC,EAAaC,EAAiBC,GAC/DF,EAAcG,EAAQC,KAAKF,EAAOF,GAClCC,EAAkBE,EAAQC,KAAKF,EAAOD,GAEtC,MAAMI,SAAEA,EAAQC,WAAEA,GA7GnB,EAA4BP,EAAMQ,EAASL,KAC1C,IAAKK,EACJ,MAAO,CAAEF,SAAUN,EAAMO,WAAY,IAGtC,MAAME,EAAiBN,EAAMO,SAASV,EAAMQ,GACtCG,EAAqBf,EAAmBgB,KAAKZ,GAEnD,IAAIM,EAAW,GAGf,MAAMC,EAAa,GAEnB,IAAIT,EAAK,EACT,IAAK,MAAMe,KAASJ,EACnB,GAAqB,iBAAVI,EACVP,GAAYO,OAER,GAAIA,EAAMC,KAAKC,WAAW,UAC9BT,GAAYU,EAAeH,EAAMI,aAE7B,CACJ,GAAIN,EACH,KAAOX,EAAKkB,SAASrB,EAAeC,KACnCA,IAIFS,EAAWY,KAAK,CAACrB,EAAIe,IACrBP,GAAYT,EAAeC,GAC3BA,GACH,CAGC,MAAO,CAAEQ,WAAUC,aACpB,EA0EkCa,CAAkBpB,EAAME,EAAiBC,GAEpEkB,EAASpB,EAAcE,EAAMO,SAASJ,EAAUL,GAAe,CAACK,GAEtE,MAxED,EAA8BgB,EAAYf,KACzC,IAAIgB,EAAI,EAMR,MAAMC,EAAaH,IAClB,IAAK,IAAII,EAAI,EAAGA,EAAIJ,EAAOK,UAEtBH,GAAKhB,EAAWmB,QAFcD,IAAK,CAMvC,MAAMZ,EAAQQ,EAAOI,GACrB,GAAqB,iBAAVZ,GAA+C,iBAAlBA,EAAMI,QAAsB,CACnE,MAAOnB,EAAI6B,GAAKpB,EAAWgB,GACrBK,EAAqB,iBAAVf,EAAqBA,EAA+BA,EAAa,QAC5EgB,EAAchC,EAAeC,GAE7BgC,EAAQF,EAAEG,QAAQF,GACxB,GAAIC,GAAQ,EAAI,GACbP,EAEF,MAAMS,EAASJ,EAAEK,UAAU,EAAGH,GACxBI,EAASP,EACTQ,EAAQP,EAAEK,UAAUH,EAAQD,EAAYH,QAGxCU,EAAc,GAChBJ,GACHI,EAAYjB,KAAKa,GAElBI,EAAYjB,KAAKe,GACbC,GACHC,EAAYjB,QAAQK,EAAW,CAACW,KAGZ,iBAAVtB,EACVQ,EAAOgB,OAAOZ,EAAG,KAAMW,GAGvBvB,EAAMI,QAAUmB,CAEtB,CACA,MAEIZ,EAAWX,EAAMI,QAErB,CAEE,OAAOI,CAAM,EAGdG,EAAWF,EACZ,EAgBCgB,CAAoBjB,EAAQd,GACrBc,CACR,CAMO,SAASkB,EAAYtC,GAC3B,MAAO,CAACD,EAAME,EAAiBC,IACvBJ,EAAWC,EAAMC,EAAauC,EAAgBtC,GAAkBC,EAEzE"}