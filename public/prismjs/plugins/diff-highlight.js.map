{"version":3,"file":"diff-highlight.js","sources":["../../src/plugins/diff-highlight/diff-highlight.js"],"sourcesContent":["import { getTextContent, Token } from '../../core/classes/token.js';\nimport prism from '../../global.js';\nimport diff, { PREFIXES } from '../../languages/diff.js';\n\n/** @type {import('../../types.d.ts').PluginProto<'diff-highlight'>} */\nconst Self = {\n\tid: 'diff-highlight',\n\trequire: diff,\n\teffect (Prism) {\n\t\tconst LANGUAGE_REGEX = /^diff-([\\w-]+)/i;\n\n\t\t/** @param {HookEnv} env */\n\t\tconst setMissingGrammar = env => {\n\t\t\tconst lang = env.language;\n\t\t\tif (LANGUAGE_REGEX.test(lang) && !env.grammar) {\n\t\t\t\tenv.grammar = Prism.languageRegistry.getLanguage('diff')?.resolvedGrammar;\n\t\t\t}\n\t\t};\n\n\t\treturn Prism.hooks.add({\n\t\t\t'before-sanity-check': setMissingGrammar,\n\t\t\t'before-tokenize': setMissingGrammar,\n\t\t\t'after-tokenize': env => {\n\t\t\t\tconst langMatch = LANGUAGE_REGEX.exec(env.language);\n\t\t\t\tif (!langMatch) {\n\t\t\t\t\treturn; // not a language specific diff\n\t\t\t\t}\n\n\t\t\t\tconst diffLanguage = langMatch[1];\n\t\t\t\tconst diffGrammar =\n\t\t\t\t\tPrism.languageRegistry.getLanguage(diffLanguage)?.resolvedGrammar;\n\t\t\t\tif (!diffGrammar) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tfor (const token of env.tokens) {\n\t\t\t\t\tif (\n\t\t\t\t\t\ttypeof token === 'string' ||\n\t\t\t\t\t\t!(token.type in PREFIXES) ||\n\t\t\t\t\t\t!Array.isArray(token.content)\n\t\t\t\t\t) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst type = token.type;\n\t\t\t\t\tlet insertedPrefixes = 0;\n\t\t\t\t\tconst getPrefixToken = () => {\n\t\t\t\t\t\tinsertedPrefixes++;\n\t\t\t\t\t\treturn new Token('prefix', PREFIXES[type], /\\w+/.exec(type)?.[0]);\n\t\t\t\t\t};\n\n\t\t\t\t\tconst withoutPrefixes = token.content.filter(\n\t\t\t\t\t\tt => typeof t === 'string' || t.type !== 'prefix'\n\t\t\t\t\t);\n\t\t\t\t\tconst prefixCount = token.content.length - withoutPrefixes.length;\n\n\t\t\t\t\tconst diffTokens = Prism.tokenize(getTextContent(withoutPrefixes), diffGrammar);\n\n\t\t\t\t\t// re-insert prefixes\n\n\t\t\t\t\t// always add a prefix at the start\n\t\t\t\t\tdiffTokens.unshift(getPrefixToken());\n\n\t\t\t\t\tconst LINE_BREAK = /\\r\\n|\\n/g;\n\t\t\t\t\t/**\n\t\t\t\t\t *\n\t\t\t\t\t * @param {string} text\n\t\t\t\t\t */\n\t\t\t\t\tconst insertAfterLineBreakString = text => {\n\t\t\t\t\t\t/** @type {TokenStream} */\n\t\t\t\t\t\tconst result = [];\n\t\t\t\t\t\tLINE_BREAK.lastIndex = 0;\n\t\t\t\t\t\tlet last = 0;\n\t\t\t\t\t\tlet m;\n\t\t\t\t\t\twhile (insertedPrefixes < prefixCount && (m = LINE_BREAK.exec(text))) {\n\t\t\t\t\t\t\tconst end = m.index + m[0].length;\n\t\t\t\t\t\t\tresult.push(text.slice(last, end));\n\t\t\t\t\t\t\tlast = end;\n\t\t\t\t\t\t\tresult.push(getPrefixToken());\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (result.length === 0) {\n\t\t\t\t\t\t\treturn undefined;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (last < text.length) {\n\t\t\t\t\t\t\tresult.push(text.slice(last));\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn result;\n\t\t\t\t\t};\n\n\t\t\t\t\t/**\n\t\t\t\t\t *\n\t\t\t\t\t * @param {TokenStream} tokens\n\t\t\t\t\t */\n\t\t\t\t\tconst insertAfterLineBreak = tokens => {\n\t\t\t\t\t\tfor (let i = 0; i < tokens.length && insertedPrefixes < prefixCount; i++) {\n\t\t\t\t\t\t\tconst token = tokens[i];\n\n\t\t\t\t\t\t\tif (typeof token === 'string') {\n\t\t\t\t\t\t\t\tconst inserted = insertAfterLineBreakString(token);\n\t\t\t\t\t\t\t\tif (inserted) {\n\t\t\t\t\t\t\t\t\ttokens.splice(i, 1, ...inserted);\n\t\t\t\t\t\t\t\t\ti += inserted.length - 1;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse if (typeof token.content === 'string') {\n\t\t\t\t\t\t\t\tconst inserted = insertAfterLineBreakString(token.content);\n\t\t\t\t\t\t\t\tif (inserted) {\n\t\t\t\t\t\t\t\t\ttoken.content = inserted;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\tinsertAfterLineBreak(token.content);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t\tinsertAfterLineBreak(diffTokens);\n\n\t\t\t\t\tif (insertedPrefixes < prefixCount) {\n\t\t\t\t\t\t// we are missing the last prefix\n\t\t\t\t\t\tdiffTokens.push(getPrefixToken());\n\t\t\t\t\t}\n\n\t\t\t\t\ttoken.content = diffTokens;\n\t\t\t\t}\n\t\t\t},\n\t\t});\n\t},\n};\n\nexport default Self;\n\nprism.pluginRegistry.add(Self);\n\n/**\n * @typedef {import('../../types.d.ts').HookEnv} HookEnv\n * @typedef {import('../../types.d.ts').TokenStream} TokenStream\n */\n"],"names":["Self","id","require","diff","effect","Prism","LANGUAGE_REGEX","setMissingGrammar","env","lang","language","test","grammar","languageRegistry","getLanguage","resolvedGrammar","hooks","add","langMatch","exec","diffLanguage","diffGrammar","token","tokens","type","PREFIXES","Array","isArray","content","insertedPrefixes","getPrefixToken","Token","withoutPrefixes","filter","t","prefixCount","length","diffTokens","tokenize","getTextContent","unshift","LINE_BREAK","insertAfterLineBreakString","text","result","lastIndex","m","last","end","index","push","slice","insertAfterLineBreak","i","inserted","splice","prism","pluginRegistry"],"mappings":"uOAKK,MAACA,EAAO,CACZC,GAAI,iBACJC,QAASC,EACT,MAAAC,CAAQC,GACP,MAAMC,EAAiB,kBAGjBC,EAAoBC,IACzB,MAAMC,EAAOD,EAAIE,SACbJ,EAAeK,KAAKF,KAAUD,EAAII,UACrCJ,EAAII,QAAUP,EAAMQ,iBAAiBC,YAAY,SAASC,gBAC9D,EAGE,OAAOV,EAAMW,MAAMC,IAAI,CACtB,sBAAuBV,EACvB,kBAAmBA,EACnB,iBAAkBC,IACjB,MAAMU,EAAYZ,EAAea,KAAKX,EAAIE,UAC1C,IAAKQ,EACJ,OAGD,MAAME,EAAeF,EAAU,GACzBG,EACLhB,EAAMQ,iBAAiBC,YAAYM,IAAeL,gBACnD,GAAKM,EAIL,IAAK,MAAMC,KAASd,EAAIe,OAAQ,CAC/B,GACkB,iBAAVD,KACLA,EAAME,QAAQC,KACfC,MAAMC,QAAQL,EAAMM,SAErB,SAGD,MAAMJ,EAAOF,EAAME,KACnB,IAAIK,EAAmB,EACvB,MAAMC,EAAiB,KACtBD,IACO,IAAIE,EAAM,SAAUN,EAASD,GAAO,MAAML,KAAKK,KAAQ,KAGzDQ,EAAkBV,EAAMM,QAAQK,QACrCC,GAAkB,iBAANA,GAA6B,WAAXA,EAAEV,OAE3BW,EAAcb,EAAMM,QAAQQ,OAASJ,EAAgBI,OAErDC,EAAahC,EAAMiC,SAASC,EAAeP,GAAkBX,GAKnEgB,EAAWG,QAAQV,KAEnB,MAAMW,EAAa,WAKbC,EAA6BC,IAElC,MAAMC,EAAS,GACfH,EAAWI,UAAY,EACvB,IACIC,EADAC,EAAO,EAEX,KAAOlB,EAAmBM,IAAgBW,EAAIL,EAAWtB,KAAKwB,KAAQ,CACrE,MAAMK,EAAMF,EAAEG,MAAQH,EAAE,GAAGV,OAC3BQ,EAAOM,KAAKP,EAAKQ,MAAMJ,EAAMC,IAC7BD,EAAOC,EACPJ,EAAOM,KAAKpB,IACnB,CAEM,GAAsB,IAAlBc,EAAOR,OAOX,OAHIW,EAAOJ,EAAKP,QACfQ,EAAOM,KAAKP,EAAKQ,MAAMJ,IAEjBH,CAAM,EAORQ,EAAuB7B,IAC5B,IAAK,IAAI8B,EAAI,EAAGA,EAAI9B,EAAOa,QAAUP,EAAmBM,EAAakB,IAAK,CACzE,MAAM/B,EAAQC,EAAO8B,GAErB,GAAqB,iBAAV/B,EAAoB,CAC9B,MAAMgC,EAAWZ,EAA2BpB,GACxCgC,IACH/B,EAAOgC,OAAOF,EAAG,KAAMC,GACvBD,GAAKC,EAASlB,OAAS,EAEhC,MACY,GAA6B,iBAAlBd,EAAMM,QAAsB,CAC3C,MAAM0B,EAAWZ,EAA2BpB,EAAMM,SAC9C0B,IACHhC,EAAMM,QAAU0B,EAEzB,MAEQF,EAAqB9B,EAAMM,QAEnC,GAEKwB,EAAqBf,GAEjBR,EAAmBM,GAEtBE,EAAWa,KAAKpB,KAGjBR,EAAMM,QAAUS,CACrB,IAGE,GAKFmB,EAAMC,eAAexC,IAAIjB"}